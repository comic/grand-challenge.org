<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Development &#8212; grand-challenge.org  documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/classic.css?v=2bf1fcf8" />
    
    <script src="_static/documentation_options.js?v=5929fcd5"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Evaluation" href="evaluation.html" />
    <link rel="prev" title="Architecture" href="architecture.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="evaluation.html" title="Evaluation"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="architecture.html" title="Architecture"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">grand-challenge.org  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Development</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <section id="development">
<h1>Development<a class="headerlink" href="#development" title="Link to this heading">¶</a></h1>
<p>Grand-challenge is distributed as a set of containers that are defined and linked together in <code class="docutils literal notranslate"><span class="pre">docker-compose.yml</span></code>.
To develop the platform you need to have docker and docker compose running on your system.</p>
<section id="installation">
<h2>Installation<a class="headerlink" href="#installation" title="Link to this heading">¶</a></h2>
<ol class="arabic">
<li><p>Download and install Docker</p>
<blockquote>
<div><p><em>Linux</em>: <a class="reference external" href="https://docs.docker.com/install/">Docker</a> and <a class="reference external" href="https://docs.docker.com/compose/install/">Docker Compose</a></p>
<p><em>Windows</em>: <a class="reference external" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10/">WSL2</a>, <a class="reference external" href="https://docs.docker.com/docker-for-windows/install/">Docker Desktop for Windows</a> with the <a class="reference external" href="https://docs.docker.com/docker-for-windows/wsl/">Docker Desktop WSL2 Backend</a> and <a class="reference external" href="https://docs.docker.com/compose/install/">Docker Compose</a></p>
</div></blockquote>
</li>
</ol>
<p><em>Note for Windows Users</em>: we <strong>only</strong> support development using Windows 10 and WSL2.
Please ensure that the correct backend is enabled in your docker settings, and run all of the following commands in the <code class="docutils literal notranslate"><span class="pre">wsl</span></code> shell.
At the time of writing, we use <code class="docutils literal notranslate"><span class="pre">Ubuntu</span> <span class="pre">20.04</span></code> from the Microsoft store as the default distro.
As WSL2 is slow at syncing files between Windows and WSL2 filesystems it is best to checkout the codebase within <code class="docutils literal notranslate"><span class="pre">wsl</span></code> itself.</p>
<p>The docker compose cycle script below utilizes <a class="reference external" href="https://docs.docker.com/buildx/working-with-buildx/#install">Docker Buildx</a>. Depending on the steps above, buildx should be
installed alongside docker. If the docker compose cycle invocation below crashes on buildx, it is recommended to
(re)install the latest version.</p>
<ol class="arabic simple" start="2">
<li><p>Clone the repo</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/comic/grand-challenge.org
<span class="gp">$ </span><span class="nb">cd</span><span class="w"> </span>grand-challenge.org
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Set your local docker group id in your <code class="docutils literal notranslate"><span class="pre">.env</span></code> file</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span><span class="nb">echo</span><span class="w"> </span><span class="nv">DOCKER_GID</span><span class="o">=</span><span class="sb">`</span>getent<span class="w"> </span>group<span class="w"> </span>docker<span class="w"> </span><span class="p">|</span><span class="w"> </span>cut<span class="w"> </span>-d:<span class="w"> </span>-f3<span class="sb">`</span><span class="w"> </span>&gt;<span class="w"> </span>.env
</pre></div>
</div>
<ol class="arabic simple" start="4">
<li><p>You can then start the development site by invoking</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>runserver
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">app/</span></code> directory is mounted in the containers,
<code class="docutils literal notranslate"><span class="pre">werkzeug</span></code> handles the file monitoring and will restart the process if any changes are detected.
You can also kill the server with <code class="docutils literal notranslate"><span class="pre">CTRL+C</span></code>.</p>
<section id="the-development-site">
<h3>The Development Site<a class="headerlink" href="#the-development-site" title="Link to this heading">¶</a></h3>
<p>If you follow the installation instructions above you will be able to go to <a class="reference external" href="https://gc.localhost">https://gc.localhost</a> to see the development site,
this is using a self-signed certificate so you will need to accept the security warning.</p>
<p>The development site will apply all migrations and add a set of fixtures to help you with developing grand-challenge.org.
These fixtures include Archives, Reader Studies, Challenges, Algorithms and Workstations.
Some default users are created with specific permissions, each user has the same username and password.
These users include <code class="docutils literal notranslate"><span class="pre">archive</span></code>, <code class="docutils literal notranslate"><span class="pre">readerstudy</span></code>, <code class="docutils literal notranslate"><span class="pre">demo</span></code>, <code class="docutils literal notranslate"><span class="pre">algorithm</span></code> and <code class="docutils literal notranslate"><span class="pre">workstation</span></code>,
who have permission to administer the existing fixtures and create new ones.</p>
<p>If you would like to test out the algorithms you can create a simple algorithm that lists its inputs in a <cite>results.json</cite> file by running</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>algorithm_evaluation_fixtures
</pre></div>
</div>
<p>Before you run</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>runserver
</pre></div>
</div>
<p>There is an interactive debugger from <code class="docutils literal notranslate"><span class="pre">django-extensions</span></code> which will halt on exceptions (see the <a class="reference external" href="https://django-extensions.readthedocs.io/en/latest/runserver_plus.html">RunServerPlus</a> documentation),
it’s really handy for interactive debugging to place <code class="docutils literal notranslate"><span class="pre">1/0</span></code> in your code as a breakpoint.</p>
</section>
</section>
<section id="running-the-tests">
<h2>Running the Tests<a class="headerlink" href="#running-the-tests" title="Link to this heading">¶</a></h2>
<p>GitHub actions is used to run the test suite on every new commit.
You can also run the tests locally by</p>
<ol class="arabic simple">
<li><p>In a console window make sure the database is running</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>runserver
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Then in a second window run</p></li>
</ol>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>compose<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>celery_worker<span class="w"> </span>pytest<span class="w"> </span>-n<span class="w"> </span><span class="m">2</span>
</pre></div>
</div>
<p>Replace 2 with the number of CPUs that you have on your system, this runs
the tests in parallel.</p>
<p>If you want to add a new test please add them to the <code class="docutils literal notranslate"><span class="pre">app/tests</span></code> folder.
If you only want to run the tests for a particular app, eg. for <code class="docutils literal notranslate"><span class="pre">teams</span></code>, you can do</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>compose<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>celery_worker<span class="w"> </span>pytest<span class="w"> </span>-k<span class="w"> </span>teams_tests
</pre></div>
</div>
</section>
<section id="id1">
<h2>Development<a class="headerlink" href="#id1" title="Link to this heading">¶</a></h2>
<p>You will need to install pre-commit so that the code is correctly formatted</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>python3<span class="w"> </span>-m<span class="w"> </span>pip<span class="w"> </span>install<span class="w"> </span>pre-commit
</pre></div>
</div>
<p>Please do all development on a branch and make a pull request to main, this will need to be reviewed before it is integrated.</p>
<p>We recommend using Pycharm for development.</p>
<section id="running-through-docker-compose">
<h3>Running through docker compose<a class="headerlink" href="#running-through-docker-compose" title="Link to this heading">¶</a></h3>
<p>You will need the Professional edition to use the docker compose integration.
To set up the environment in Pycharm Professional 2018.1:</p>
<ol class="arabic simple">
<li><p><code class="docutils literal notranslate"><span class="pre">File</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Settings</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Project:</span> <span class="pre">grand-challenge.org</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Project</span> <span class="pre">Interpreter</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Cog</span></code> wheel (top right) -&gt; <code class="docutils literal notranslate"><span class="pre">Add</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Docker</span> <span class="pre">Compose</span></code></p></li>
<li><p>Then select the docker server (usually the unix socket, or Docker for Windows)</p></li>
<li><p>Set the service to <code class="docutils literal notranslate"><span class="pre">web</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code></p></li>
<li><p>Set the path mappings:</p>
<ol class="arabic simple">
<li><p>Local path: <code class="docutils literal notranslate"><span class="pre">&lt;Project</span> <span class="pre">root&gt;/app</span></code></p></li>
<li><p>Remote path: <code class="docutils literal notranslate"><span class="pre">/app</span></code></p></li>
</ol>
</li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code></p></li>
</ol>
<p>Pycharm will then spend some time indexing the packages within the container to help with code completion and inspections.
If you edit any files these will be updated on the fly by werkzeug.</p>
</section>
<section id="pycharm-configuration">
<h3>PyCharm Configuration<a class="headerlink" href="#pycharm-configuration" title="Link to this heading">¶</a></h3>
<p>It is recommended to setup django integration to ensure that the code completion, tests and import optimisation works.</p>
<ol class="arabic simple">
<li><p>Open <code class="docutils literal notranslate"><span class="pre">File</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Settings</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Languages</span> <span class="pre">and</span> <span class="pre">Frameworks</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Django</span></code></p></li>
<li><p>Check the <code class="docutils literal notranslate"><span class="pre">Enable</span> <span class="pre">Django</span> <span class="pre">Support</span></code> checkbox</p></li>
<li><p>Set the project root to <code class="docutils literal notranslate"><span class="pre">&lt;Project</span> <span class="pre">root&gt;/app</span></code></p></li>
<li><p>Set the settings to <code class="docutils literal notranslate"><span class="pre">config/settings.py</span></code></p></li>
<li><p>Check the <code class="docutils literal notranslate"><span class="pre">Do</span> <span class="pre">not</span> <span class="pre">use</span> <span class="pre">the</span> <span class="pre">django</span> <span class="pre">test</span> <span class="pre">runner</span></code> checkbox</p></li>
<li><p>In the settings window navigate to <code class="docutils literal notranslate"><span class="pre">Tools</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Python</span> <span class="pre">integrated</span> <span class="pre">tools</span></code></p></li>
<li><p>Under the testing section select <code class="docutils literal notranslate"><span class="pre">pytest</span></code> as the default test runner</p></li>
<li><p>Under the Docstrings section set <code class="docutils literal notranslate"><span class="pre">NumPy</span></code> as the docstrings format</p></li>
<li><p>In the settings window navigate to <code class="docutils literal notranslate"><span class="pre">Editor</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Code</span> <span class="pre">Style</span></code></p></li>
<li><p>Click on the <code class="docutils literal notranslate"><span class="pre">Formatter</span> <span class="pre">Control</span></code> tab and enable <code class="docutils literal notranslate"><span class="pre">Enable</span> <span class="pre">formatter</span> <span class="pre">markers</span> <span class="pre">in</span> <span class="pre">comments</span></code></p></li>
<li><p>In the settings window navigate to <code class="docutils literal notranslate"><span class="pre">Editor</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Code</span> <span class="pre">Style</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Python</span></code></p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Wrapping</span> <span class="pre">and</span> <span class="pre">Braces</span></code> tab set <code class="docutils literal notranslate"><span class="pre">Hard</span> <span class="pre">wrap</span> <span class="pre">at</span></code> to <code class="docutils literal notranslate"><span class="pre">86</span></code> and <code class="docutils literal notranslate"><span class="pre">Visual</span> <span class="pre">guide</span></code> to <code class="docutils literal notranslate"><span class="pre">79</span></code></p></li>
<li><p>On the <code class="docutils literal notranslate"><span class="pre">Imports</span></code> tab enable <code class="docutils literal notranslate"><span class="pre">Sort</span> <span class="pre">Import</span> <span class="pre">Statements</span></code>, <code class="docutils literal notranslate"><span class="pre">Sort</span> <span class="pre">imported</span> <span class="pre">names</span> <span class="pre">in</span> <span class="pre">&quot;from&quot;</span> <span class="pre">imports</span></code>, and <code class="docutils literal notranslate"><span class="pre">Sort</span> <span class="pre">plain</span> <span class="pre">and</span> <span class="pre">&quot;from&quot;</span> <span class="pre">imports</span> <span class="pre">separately</span> <span class="pre">in</span> <span class="pre">the</span> <span class="pre">same</span> <span class="pre">group</span></code></p></li>
<li><p>Click <code class="docutils literal notranslate"><span class="pre">OK</span></code></p></li>
<li><p>Install the <code class="docutils literal notranslate"><span class="pre">Flake8</span> <span class="pre">Support</span></code> plugin so that PyCharm will understand <code class="docutils literal notranslate"><span class="pre">noqa</span></code> comments. At the time of writing, the plugin is not compatible with PyCharm 2020. You can still install Flake8 as an external tool though. To do so, follow these steps:</p>
<ol class="arabic simple">
<li><p>Install flake8 <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">flake8</span></code></p></li>
<li><p>In PyCharm, in the settings window navigate to <code class="docutils literal notranslate"><span class="pre">Tools</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">External</span> <span class="pre">Tools</span></code> and add a new one with the following configuration:</p>
<ol class="arabic simple">
<li><p>Program: file path to <code class="docutils literal notranslate"><span class="pre">flake8.exe</span></code> you just installed</p></li>
<li><p>Arguments: <code class="docutils literal notranslate"><span class="pre">$FilePath$</span></code></p></li>
<li><p>Working directory: <code class="docutils literal notranslate"><span class="pre">$ProjectFileDir$</span></code></p></li>
</ol>
</li>
</ol>
</li>
<li><p>In the main window at the top right click the drop down box and then click <code class="docutils literal notranslate"><span class="pre">Edit</span> <span class="pre">Configurations...</span></code></p></li>
<li><p>Click on <code class="docutils literal notranslate"><span class="pre">templates</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">Python</span> <span class="pre">Tests</span></code> -&gt; <code class="docutils literal notranslate"><span class="pre">pytest</span></code>, and enter <code class="docutils literal notranslate"><span class="pre">--reuse-db</span></code> in the <code class="docutils literal notranslate"><span class="pre">Additional</span> <span class="pre">Arguments</span></code> box and <code class="docutils literal notranslate"><span class="pre">run</span> <span class="pre">--rm</span></code> in the <code class="docutils literal notranslate"><span class="pre">Command</span> <span class="pre">and</span> <span class="pre">options</span></code> box under <code class="docutils literal notranslate"><span class="pre">Docker</span> <span class="pre">Compose</span></code></p></li>
</ol>
<p>It is also recommended to install the black extension for code formatting. You can add it as an external tool, following the same instructions as for <code class="docutils literal notranslate"><span class="pre">Flake8</span></code> above.</p>
</section>
</section>
<section id="creating-migrations">
<h2>Creating Migrations<a class="headerlink" href="#creating-migrations" title="Link to this heading">¶</a></h2>
<p>If you change a <code class="docutils literal notranslate"><span class="pre">models.py</span></code> file then you will need to make the corresponding migration files.
You can do this with</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>migrations
</pre></div>
</div>
<p>or, more explicitly</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>docker<span class="w"> </span>compose<span class="w"> </span>run<span class="w"> </span>--rm<span class="w"> </span>--user<span class="w"> </span><span class="sb">`</span>id<span class="w"> </span>-u<span class="sb">`</span><span class="w"> </span>web<span class="w"> </span>python<span class="w"> </span>manage.py<span class="w"> </span>makemigrations
</pre></div>
</div>
<p>add these to git and commit.</p>
</section>
<section id="building-the-documentation">
<h2>Building the documentation<a class="headerlink" href="#building-the-documentation" title="Link to this heading">¶</a></h2>
<p>Having built the web container with <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">runserver</span></code> you can use this to generate the docs with</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>make<span class="w"> </span>docs
</pre></div>
</div>
<p>This will create the docs in the <code class="docutils literal notranslate"><span class="pre">docs/_build/html</span></code> directory.</p>
</section>
<section id="adding-new-dependencies">
<h2>Adding new dependencies<a class="headerlink" href="#adding-new-dependencies" title="Link to this heading">¶</a></h2>
<p>Poetry is used to manage the dependencies of the platform.
To add a new dependency use</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>poetry<span class="w"> </span>add<span class="w"> </span>&lt;whatever&gt;
</pre></div>
</div>
<p>and then commit the <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> and <code class="docutils literal notranslate"><span class="pre">poetry.lock</span></code>.
If this is a development dependency then use the <code class="docutils literal notranslate"><span class="pre">--dev</span></code> flag, see the <code class="docutils literal notranslate"><span class="pre">poetry</span></code> documentation for more details.</p>
<p>Versions are unpinned in the <code class="docutils literal notranslate"><span class="pre">pyproject.toml</span></code> file, to update the resolved dependencies use</p>
<div class="highlight-console notranslate"><div class="highlight"><pre><span></span><span class="gp">$ </span>poetry<span class="w"> </span>update<span class="w"> </span>&lt;whatever&gt;
</pre></div>
</div>
<p>and commit the updated <code class="docutils literal notranslate"><span class="pre">poetry.lock</span></code>.</p>
<p>The containers will need to be rebuilt after running these steps, so stop the <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">runserver</span></code> process with <code class="docutils literal notranslate"><span class="pre">CTRL+C</span></code> and restart.</p>
</section>
<section id="going-to-production">
<h2>Going to Production<a class="headerlink" href="#going-to-production" title="Link to this heading">¶</a></h2>
<p>The docker compose file included here is for development only.
If you want to run this in a production environment you will need to make several changes, not limited to:</p>
<ol class="arabic simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">gunicorn</span></code> rather than run <code class="docutils literal notranslate"><span class="pre">runserver_plus</span></code> to run the web process</p></li>
<li><p><a class="reference external" href="https://docs.docker.com/engine/security/https/">Disable mounting of the docker socket</a></p></li>
<li><p>Removing the users that are created by <code class="docutils literal notranslate"><span class="pre">development_fixtures</span></code></p></li>
</ol>
</section>
</section>


            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
  <div>
    <h4>Previous topic</h4>
    <p class="topless"><a href="architecture.html"
                          title="previous chapter">Architecture</a></p>
  </div>
  <div>
    <h4>Next topic</h4>
    <p class="topless"><a href="evaluation.html"
                          title="next chapter">Evaluation</a></p>
  </div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="right" >
          <a href="evaluation.html" title="Evaluation"
             >next</a> |</li>
        <li class="right" >
          <a href="architecture.html" title="Architecture"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">grand-challenge.org  documentation</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">Development</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2018, James Meakin.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.1.
    </div>
  </body>
</html>