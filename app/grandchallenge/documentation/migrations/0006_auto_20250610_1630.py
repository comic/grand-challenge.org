# Generated by Django 4.2.21 on 2025-06-10 16:30
from bs4 import BeautifulSoup
from django.db import migrations

from grandchallenge.core.templatetags.bleach import md2html


def markdown_to_plain_text(md):
    if not md:
        return ""
    return BeautifulSoup(
        md2html(md, create_permalink_for_headers=False),
        "html.parser",
    ).get_text()


def generate_content_plain(apps, schema_editor):
    DocPage = apps.get_model("documentation", "DocPage")  # noqa: N806

    for doc in DocPage.objects.all():
        plain_text = markdown_to_plain_text(doc.content)
        DocPage.objects.filter(pk=doc.pk).update(content_plain=plain_text)


class Migration(migrations.Migration):

    dependencies = [
        ("documentation", "0005_docpage_content_plain_and_more"),
    ]

    operations = [
        migrations.RunPython(generate_content_plain, elidable=True),
    ]
