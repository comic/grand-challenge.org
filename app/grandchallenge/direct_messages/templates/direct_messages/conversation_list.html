{% extends "base.html" %}
{% load static %}
{% load url %}

{% block title %}Conversations - {{ block.super }}{% endblock %}

{% block content %}
    <h2>Conversations</h2>

    <div class="d-flex w-100 align-items-stretch" style="height: 75vh">

        <div class="list-group overflow-auto flex-shrink-0" hx-target="#conversation-detail-panel">
            {% for conversation in object_list %}
                <button type="button" hx-get="{{ conversation.get_absolute_url }}" class="list-group-item list-group-item-action conversation-detail-select">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">
                            {% for participant in conversation.participants.all %}
                                {% if participant != request.user %}
                                    <img class="rounded-circle align-middle"
                                         src="{{ participant.user_profile.get_mugshot_url }}"
                                         alt="User Mugshot" style="height: 1.33em"/>&nbsp;<b>{{ participant.first_name }}&nbsp;{{ participant.last_name }}</b>&nbsp;({{ participant.username }})
                                {% endif %}
                            {% endfor %}
                        </h6>

                        {% if conversation.unread_by_user %}
                            <span class="text-danger">
                                <i class="fa fa-xs fa-circle"></i>
                            </span>
                        {% endif %}
                    </div>

                    <p class="mb-1">
                        {% if conversation.direct_messages.first.sender == request.user %}
                            You:
                        {% else %}
                            {{ conversation.direct_messages.first.sender.first_name }}:
                        {% endif %}
                        {{ conversation.direct_messages.first.message|truncatewords:4 }}
                    </p>

                    <small>{{ conversation.direct_messages.first.created }}</small>

                    <form class="conversation-mark-read-form" action="{% url 'direct-messages:conversation-mark-read' pk=conversation.pk %}" method="post">
                        {% csrf_token %}
                    </form>
                </button>
            {% endfor %}
        </div>

        <div class="card w-100">
            <div id="conversation-detail-panel" class="card-body d-flex flex-column"></div>
        </div>

    </div>
{% endblock %}

{% block script %}
    {{ block.super }}

    <script type="module" src="{% static 'js/direct_messages/direct_message_list.mjs' %}"></script>
{% endblock %}
