<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>grandchallenge.reader_studies.models &#8212; grand-challenge.org  documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="../../../_static/classic.css?v=2bf1fcf8" />
    
    <script src="../../../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../../../_static/doctools.js?v=9bcbadda"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">grand-challenge.org  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">grandchallenge.reader_studies.models</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for grandchallenge.reader_studies.models</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span><span class="w"> </span><span class="nn">math</span><span class="w"> </span><span class="kn">import</span> <span class="n">ceil</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">django.conf</span><span class="w"> </span><span class="kn">import</span> <span class="n">settings</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth</span><span class="w"> </span><span class="kn">import</span> <span class="n">get_user_model</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.contrib.auth.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Group</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">ObjectDoesNotExist</span><span class="p">,</span> <span class="n">ValidationError</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.core.validators</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">MaxLengthValidator</span><span class="p">,</span>
    <span class="n">MaxValueValidator</span><span class="p">,</span>
    <span class="n">MinLengthValidator</span><span class="p">,</span>
    <span class="n">MinValueValidator</span><span class="p">,</span>
    <span class="n">RegexValidator</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db</span><span class="w"> </span><span class="kn">import</span> <span class="n">models</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Avg</span><span class="p">,</span> <span class="n">Count</span><span class="p">,</span> <span class="n">Q</span><span class="p">,</span> <span class="n">Sum</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.db.models.signals</span><span class="w"> </span><span class="kn">import</span> <span class="n">post_delete</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.dispatch</span><span class="w"> </span><span class="kn">import</span> <span class="n">receiver</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django.utils.functional</span><span class="w"> </span><span class="kn">import</span> <span class="n">cached_property</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">django_extensions.db.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">TitleSlugDescriptionModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">guardian.shortcuts</span><span class="w"> </span><span class="kn">import</span> <span class="n">assign_perm</span><span class="p">,</span> <span class="n">remove_perm</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">referencing.exceptions</span><span class="w"> </span><span class="kn">import</span> <span class="n">Unresolvable</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">stdimage</span><span class="w"> </span><span class="kn">import</span> <span class="n">JPEGField</span>

<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.anatomy.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">BodyStructure</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.components.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">CIVForObjectMixin</span><span class="p">,</span>
    <span class="n">CIVSetObjectPermissionsMixin</span><span class="p">,</span>
    <span class="n">CIVSetStringRepresentationMixin</span><span class="p">,</span>
    <span class="n">ComponentInterface</span><span class="p">,</span>
    <span class="n">ComponentInterfaceValue</span><span class="p">,</span>
    <span class="n">InterfaceKindChoices</span><span class="p">,</span>
    <span class="n">InterfaceKinds</span><span class="p">,</span>
    <span class="n">LinkedComponentInterfacesMixin</span><span class="p">,</span>
    <span class="n">OverlaySegmentsMixin</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.components.schemas</span><span class="w"> </span><span class="kn">import</span> <span class="n">ANSWER_TYPE_SCHEMA</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.core.fields</span><span class="w"> </span><span class="kn">import</span> <span class="n">HexColorField</span><span class="p">,</span> <span class="n">RegexField</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.core.guardian</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">GroupObjectPermissionBase</span><span class="p">,</span>
    <span class="n">UserObjectPermissionBase</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.core.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">RequestBase</span><span class="p">,</span> <span class="n">UUIDModel</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.core.storage</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_logo_path</span><span class="p">,</span>
    <span class="n">get_social_image_path</span><span class="p">,</span>
    <span class="n">public_s3_storage</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.core.templatetags.bleach</span><span class="w"> </span><span class="kn">import</span> <span class="n">md2html</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.core.templatetags.remove_whitespace</span><span class="w"> </span><span class="kn">import</span> <span class="n">oxford_comma</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.core.utils.access_requests</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">AccessRequestHandlingOptions</span><span class="p">,</span>
    <span class="n">process_access_request</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.core.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">JSONValidator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.core.vendored.django.validators</span><span class="w"> </span><span class="kn">import</span> <span class="n">StepValueValidator</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.hanging_protocols.models</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">HangingProtocolMixin</span><span class="p">,</span>
    <span class="n">ViewportNames</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.modalities.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">ImagingModality</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.organizations.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Organization</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.publications.models</span><span class="w"> </span><span class="kn">import</span> <span class="n">Publication</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.reader_studies.interactive_algorithms</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">InteractiveAlgorithmChoices</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.reader_studies.metrics</span><span class="w"> </span><span class="kn">import</span> <span class="n">accuracy_score</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.subdomains.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.workstations.templatetags.workstations</span><span class="w"> </span><span class="kn">import</span> <span class="p">(</span>
    <span class="n">get_workstation_path_and_query_string</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">grandchallenge.workstations.utils</span><span class="w"> </span><span class="kn">import</span> <span class="n">reassign_workstation_permissions</span>

<span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">A reader study enables you to have a set of readers answer a set of questions</span>
<span class="s2">about a set of images.</span>

<span class="s2">Editors</span>
<span class="s2">    You can add multiple editors to your reader study.</span>
<span class="s2">    An editor is someone who can edit the reader study settings, add other editors,</span>
<span class="s2">    add and remove readers, add images and edit questions.</span>
<span class="s2">Readers</span>
<span class="s2">    A user who can read this study, creating an answer for each question and</span>
<span class="s2">    image in the study.</span>
<span class="s2">Cases</span>
<span class="s2">    The set of images that will be used in the study.</span>
<span class="s2">Hanging List</span>
<span class="s2">    How the each image will be presented to the user as a set of hanging protocols.</span>
<span class="s2">    For instance, you might want to present two images side by side and</span>
<span class="s2">    have a reader answer a question about both, or overlay one image</span>
<span class="s2">    on another.</span>


<span class="s2">Creating a Reader Study</span>
<span class="s2">-----------------------</span>

<span class="s2">A ``ReaderStudy`` can use any available ``Workstation``.</span>
<span class="s2">A ``WorkstationConfig`` can also be used for the study to customise the default</span>
<span class="s2">appearance of the workstation.</span>

<span class="s2">Cases</span>
<span class="s2">-----</span>

<span class="s2">Cases can be added to a reader study by adding ``Image`` instances.</span>
<span class="s2">Multiple image formats are supported:</span>

<span class="s2">* ``.mha``</span>
<span class="s2">* ``.mhd`` with the accompanying ``.zraw`` or ``.raw`` file</span>
<span class="s2">* ``.tif``/``.tiff``</span>
<span class="s2">* ``.jpg``/``.jpeg``</span>
<span class="s2">* ``.png``</span>
<span class="s2">* 3D/4D DICOM support is also available, though this is experimental and not</span>
<span class="s2">  guaranteed to work on all ``.dcm`` images.</span>

<span class="s2">Defining the Hanging List</span>
<span class="s2">-------------------------</span>

<span class="s2">When you upload a set of images you have the option to automatically generate</span>
<span class="s2">the default hanging list.</span>
<span class="s2">The default hanging list presents each reader with 1 image per protocol.</span>

<span class="s2">You are able to customise the hanging list in the study edit page.</span>
<span class="s2">Here, you are able to assign multiple images and overlays to each protocol.</span>

<span class="s2">Available image ports are:</span>
<span class="s2">* ``main``</span>
<span class="s2">* ``secondary``</span>
<span class="s2">* ``tertiary``</span>
<span class="s2">* ``quaternary``</span>
<span class="s2">* ``quinary``</span>
<span class="s2">* ``senary``</span>
<span class="s2">* ``septenary``</span>
<span class="s2">* ``octonary``</span>
<span class="s2">* ``nonary``</span>
<span class="s2">* ``denary``</span>

<span class="s2">Overlays can be applied to the image ports by using the image-port name with</span>
<span class="s2">the suffix &#39;-overlay&#39; (e.g. ``main-overlay``).</span>

<span class="s2">Questions</span>
<span class="s2">---------</span>

<span class="s2">A ``Question`` can be optional and the following ``answer_type`` options are</span>
<span class="s2">available:</span>

<span class="s2">* Heading (not answerable)</span>
<span class="s2">* Bool</span>
<span class="s2">* Single line text</span>
<span class="s2">* Multiline text</span>

<span class="s2">The following annotation answer types are also available:</span>

<span class="s2">* Distance measurement</span>
<span class="s2">* Multiple distance measurements</span>
<span class="s2">* 2D bounding box</span>

<span class="s2">To use an annotation answer type you must also select the image port where the</span>
<span class="s2">annotation will be made.</span>

<span class="s2">Adding Ground Truth</span>
<span class="s2">-------------------</span>

<span class="s2">To monitor the performance of the readers you are able add ground truth to a</span>
<span class="s2">reader study by uploading a csv file.</span>

<span class="s2">If ground truth has been added to a ``ReaderStudy``, any ``Answer`` given by a</span>
<span class="s2">reader is evaluated by applying the ``scoring_function`` chosen for the ``Question``.</span>

<span class="s2">The scores can then be compared on the ``leaderboard``. Statistics are also available</span>
<span class="s2">based on these scores: the average and total scores for each question as well</span>
<span class="s2">as for each case are displayed in the ``statistics`` view.</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="n">CASE_TEXT_SCHEMA</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span>
    <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
<span class="p">}</span>


<div class="viewcode-block" id="ReaderStudy">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ReaderStudy</span><span class="p">(</span>
    <span class="n">UUIDModel</span><span class="p">,</span>
    <span class="n">TitleSlugDescriptionModel</span><span class="p">,</span>
    <span class="n">HangingProtocolMixin</span><span class="p">,</span>
    <span class="n">LinkedComponentInterfacesMixin</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Reader Study model.</span>

<span class="sd">    A reader study is a tool that allows users to have a set of readers answer</span>
<span class="sd">    a set of questions on a set of images (cases).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">editors_group</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="n">Group</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
        <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;editors_of_readerstudy&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">readers_group</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">OneToOneField</span><span class="p">(</span>
        <span class="n">Group</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span>
        <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;readers_of_readerstudy&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">workstation</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;workstations.Workstation&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span>
    <span class="p">)</span>
    <span class="n">workstation_sessions</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="s2">&quot;workstations.Session&quot;</span><span class="p">,</span>
        <span class="n">through</span><span class="o">=</span><span class="s2">&quot;WorkstationSessionReaderStudy&quot;</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;reader_studies&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">editable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">workstation_config</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;workstation_configs.WorkstationConfig&quot;</span><span class="p">,</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">SET_NULL</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">optional_hanging_protocols</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="s2">&quot;hanging_protocols.HangingProtocol&quot;</span><span class="p">,</span>
        <span class="n">through</span><span class="o">=</span><span class="s2">&quot;OptionalHangingProtocolReaderStudy&quot;</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;optional_for_reader_study&quot;</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Optional alternative hanging protocols for this reader study&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">public</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;Should this reader study be visible to all users on the &quot;</span>
            <span class="s2">&quot;overview page? This does not grant all users permission to read &quot;</span>
            <span class="s2">&quot;this study. Users will still need to be added to the &quot;</span>
            <span class="s2">&quot;study&#39;s readers group in order to do that.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">access_request_handling</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">AccessRequestHandlingOptions</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">AccessRequestHandlingOptions</span><span class="o">.</span><span class="n">MANUAL_REVIEW</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;How would you like to handle access requests?&quot;</span><span class="p">),</span>
    <span class="p">)</span>
    <span class="n">logo</span> <span class="o">=</span> <span class="n">JPEGField</span><span class="p">(</span>
        <span class="n">upload_to</span><span class="o">=</span><span class="n">get_logo_path</span><span class="p">,</span>
        <span class="n">storage</span><span class="o">=</span><span class="n">public_s3_storage</span><span class="p">,</span>
        <span class="n">variations</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">STDIMAGE_LOGO_VARIATIONS</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">social_image</span> <span class="o">=</span> <span class="n">JPEGField</span><span class="p">(</span>
        <span class="n">upload_to</span><span class="o">=</span><span class="n">get_social_image_path</span><span class="p">,</span>
        <span class="n">storage</span><span class="o">=</span><span class="n">public_s3_storage</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;An image for this reader study which is displayed when you post the link on social media. Should have a resolution of 640x320 px (1280x640 px for best display).&quot;</span><span class="p">,</span>
        <span class="n">variations</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">STDIMAGE_SOCIAL_VARIATIONS</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">help_text_markdown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">shuffle_hanging_list</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">is_educational</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If checked, readers get the option to verify their answers &quot;</span>
            <span class="s2">&quot;against the uploaded ground truth. This also means that &quot;</span>
            <span class="s2">&quot;the uploaded ground truth will be readily available to &quot;</span>
            <span class="s2">&quot;the readers.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">instant_verification</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;In an educational reader study, enabling this setting will allow the &quot;</span>
            <span class="s2">&quot;user to go through the reader study faster. The &#39;Save and continue&#39; &quot;</span>
            <span class="s2">&quot;button will be replaced by a &#39;Verify and continue&#39; button which will &quot;</span>
            <span class="s2">&quot;show the answer verification pop up and allow the user to save and go &quot;</span>
            <span class="s2">&quot;to the next case upon dismissal.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">case_text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">JSONField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="nb">dict</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">JSONValidator</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">CASE_TEXT_SCHEMA</span><span class="p">)],</span>
    <span class="p">)</span>
    <span class="n">allow_answer_modification</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If true, readers are allowed to modify their answers for a case &quot;</span>
            <span class="s2">&quot;by navigating back to previous cases. &#39;Allow case navigation&#39; must &quot;</span>
            <span class="s2">&quot;be checked as well to enable this setting.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">enable_autosaving</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If true, answers to questions are saved in the background while a &quot;</span>
            <span class="s2">&quot;user reads a case. &#39;Allow Answer Modification&#39; must be &quot;</span>
            <span class="s2">&quot;enabled as well for this to work.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">allow_case_navigation</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If true, readers are allowed to navigate back and forth between &quot;</span>
            <span class="s2">&quot;cases in this reader study.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">allow_show_all_annotations</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If true, readers are allowed to show/hide all annotations &quot;</span>
            <span class="s2">&quot;for a case.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">roll_over_answers_for_n_cases</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The number of cases for which answers should roll over. &quot;</span>
            <span class="s2">&quot;It can be used for repeated readings with slightly different hangings. &quot;</span>
            <span class="s2">&quot;For instance, if set to 1. Case 2 will start with the answers from case 1; &quot;</span>
            <span class="s2">&quot;whereas case 3 starts anew but its answers will roll over to case 4. &quot;</span>
            <span class="s2">&quot;Setting it to 0 (default) means answers will not roll over.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">publications</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="n">Publication</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;The publications associated with this reader study&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">modalities</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="n">ImagingModality</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;The imaging modalities contained in this reader study&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">structures</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="n">BodyStructure</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;The structures contained in this reader study&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">organizations</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="n">Organization</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;The organizations associated with this reader study&quot;</span><span class="p">,</span>
        <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;readerstudies&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">leaderboard_accessible_to_readers</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;If checked, readers can see the leaderboard. &quot;</span>
            <span class="s2">&quot;Usernames and avatars will be hidden to protect other readers&#39; privacy.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>
    <span class="n">end_of_study_text_markdown</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Text to show when a user has completed the reader study&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">max_credits</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;The maximum number of credits that may be consumed for this reader study. Leave blank to allow unlimited usage.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">(</span><span class="n">UUIDModel</span><span class="o">.</span><span class="n">Meta</span><span class="p">,</span> <span class="n">TitleSlugDescriptionModel</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">verbose_name_plural</span> <span class="o">=</span> <span class="s2">&quot;reader studies&quot;</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;created&quot;</span><span class="p">,)</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;read_readerstudy&quot;</span><span class="p">,</span> <span class="s2">&quot;Can read reader study&quot;</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;view_leaderboard&quot;</span><span class="p">,</span> <span class="s2">&quot;Can view leaderboard&quot;</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="n">copy_fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;workstation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;workstation_config&quot;</span><span class="p">,</span>
        <span class="s2">&quot;logo&quot;</span><span class="p">,</span>
        <span class="s2">&quot;social_image&quot;</span><span class="p">,</span>
        <span class="s2">&quot;help_text_markdown&quot;</span><span class="p">,</span>
        <span class="s2">&quot;shuffle_hanging_list&quot;</span><span class="p">,</span>
        <span class="s2">&quot;is_educational&quot;</span><span class="p">,</span>
        <span class="s2">&quot;instant_verification&quot;</span><span class="p">,</span>
        <span class="s2">&quot;roll_over_answers_for_n_cases&quot;</span><span class="p">,</span>
        <span class="s2">&quot;allow_answer_modification&quot;</span><span class="p">,</span>
        <span class="s2">&quot;enable_autosaving&quot;</span><span class="p">,</span>
        <span class="s2">&quot;allow_case_navigation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;allow_show_all_annotations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;access_request_handling&quot;</span><span class="p">,</span>
        <span class="s2">&quot;public&quot;</span><span class="p">,</span>
        <span class="s2">&quot;leaderboard_accessible_to_readers&quot;</span><span class="p">,</span>
        <span class="s2">&quot;publications&quot;</span><span class="p">,</span>
        <span class="s2">&quot;modalities&quot;</span><span class="p">,</span>
        <span class="s2">&quot;structures&quot;</span><span class="p">,</span>
        <span class="s2">&quot;organizations&quot;</span><span class="p">,</span>
        <span class="s2">&quot;end_of_study_text_markdown&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">optional_copy_fields</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;editors_group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;readers_group&quot;</span><span class="p">,</span>
        <span class="s2">&quot;questions&quot;</span><span class="p">,</span>
        <span class="s2">&quot;display_sets&quot;</span><span class="p">,</span>
        <span class="s2">&quot;case_text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;view_content&quot;</span><span class="p">,</span>
        <span class="s2">&quot;hanging_protocol&quot;</span><span class="p">,</span>
        <span class="s2">&quot;optional_hanging_protocols&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ground_truth_file_headers</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span>
            <span class="n">q</span><span class="o">.</span><span class="n">question_text</span> <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_applicable_questions</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_ground_truth_csv_dict</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">answers</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">q</span><span class="o">.</span><span class="n">question_text</span><span class="p">:</span> <span class="n">q</span><span class="o">.</span><span class="n">example_answer</span>
            <span class="k">for</span> <span class="n">q</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_applicable_questions</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">images</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_groups</span><span class="p">:</span>
            <span class="n">_answers</span> <span class="o">=</span> <span class="n">answers</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">_answers</span><span class="p">[</span><span class="s2">&quot;case&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">images</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_answers</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">result</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_example_ground_truth_csv_text</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;No cases in this reader study&quot;</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_file_headers</span>
        <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">headers</span><span class="p">),</span>
                <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">x</span><span class="p">[</span><span class="n">header</span><span class="p">]</span> <span class="k">for</span> <span class="n">header</span> <span class="ow">in</span> <span class="n">headers</span><span class="p">])</span>
                        <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_ground_truth_csv_dict</span><span class="p">()[:</span><span class="n">limit</span><span class="p">]</span>
                    <span class="p">]</span>
                <span class="p">),</span>
            <span class="p">]</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;reader-studies:detail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">})</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">api_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;api:reader-study-detail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">})</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">_editors&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="si">}</span><span class="s2">_readers&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assign_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Allow the editors group to change this study</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;change_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span> <span class="bp">self</span>
        <span class="p">)</span>

        <span class="c1"># Allow the editors and readers groups to read this study</span>
        <span class="n">assign_perm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;read_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;read_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Allow readers and editors to add answers (globally)</span>
        <span class="c1"># adding them to this reader study is checked in the serializers as</span>
        <span class="c1"># there is no get_permission_object in django rest framework.</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Answer</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">.add_</span><span class="si">{</span><span class="n">Answer</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">Answer</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">app_label</span><span class="si">}</span><span class="s2">.add_</span><span class="si">{</span><span class="n">Answer</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># Allow the editors and readers groups to view this study</span>
        <span class="n">assign_perm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;view_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;view_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="n">reg_and_anon</span> <span class="o">=</span> <span class="n">Group</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="n">settings</span><span class="o">.</span><span class="n">REGISTERED_AND_ANON_USERS_GROUP_NAME</span>
        <span class="p">)</span>

        <span class="c1"># Allow editors to view the leaderboard</span>
        <span class="n">assign_perm</span><span class="p">(</span><span class="s2">&quot;view_leaderboard&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">leaderboard_accessible_to_readers</span><span class="p">:</span>
            <span class="n">assign_perm</span><span class="p">(</span><span class="s2">&quot;view_leaderboard&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remove_perm</span><span class="p">(</span><span class="s2">&quot;view_leaderboard&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">public</span><span class="p">:</span>
            <span class="n">assign_perm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;view_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">reg_and_anon</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">remove_perm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;view_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">reg_and_anon</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>

<div class="viewcode-block" id="ReaderStudy.clean">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.clean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">case_text</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">case_text</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_content</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_questions</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">question</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">questions</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
            <span class="n">question</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>

<div class="viewcode-block" id="ReaderStudy.save">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">adding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span>

        <span class="k">if</span> <span class="n">adding</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">create_groups</span><span class="p">()</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">assign_permissions</span><span class="p">()</span>
        <span class="n">reassign_workstation_permissions</span><span class="p">(</span>
            <span class="n">groups</span><span class="o">=</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span><span class="p">),</span>
            <span class="n">workstation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">workstation</span><span class="p">,</span>
        <span class="p">)</span></div>


<div class="viewcode-block" id="ReaderStudy.is_editor">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.is_editor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if ``user`` is an editor for this ``ReaderStudy``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span></div>


<div class="viewcode-block" id="ReaderStudy.add_editor">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.add_editor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds ``user`` as an editor for this ``ReaderStudy``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span><span class="p">)</span></div>


<div class="viewcode-block" id="ReaderStudy.remove_editor">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.remove_editor">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_editor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes ``user`` as an editor for this ``ReaderStudy``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">editors_group</span><span class="p">)</span></div>


<div class="viewcode-block" id="ReaderStudy.is_reader">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.is_reader">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Checks if ``user`` is a reader for this ``ReaderStudy``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span><span class="o">.</span><span class="n">pk</span><span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span></div>


<div class="viewcode-block" id="ReaderStudy.add_reader">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.add_reader">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Adds ``user`` as a reader for this ``ReaderStudy``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span><span class="p">)</span></div>


<div class="viewcode-block" id="ReaderStudy.remove_reader">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.remove_reader">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Removes ``user`` as a reader for this ``ReaderStudy``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">user</span><span class="o">.</span><span class="n">groups</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">readers_group</span><span class="p">)</span></div>


    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">study_image_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Names for all images added to this ``ReaderStudy``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span>
            <span class="nb">list</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">values__image__isnull</span><span class="o">=</span><span class="kc">False</span>
                <span class="p">)</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;values__image__name&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">image_groups</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Names of the images as they are grouped in the hanging list.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">all</span><span class="p">()</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;pk&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">has_ground_truth</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">question__reader_study_id</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">True</span>
        <span class="p">)</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">answerable_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        All questions for this ``ReaderStudy`` except those with answer type</span>
<span class="sd">        `heading`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">questions</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">answer_type__in</span><span class="o">=</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">get_non_answerable_types</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">answerable_question_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The number of answerable questions for this ``ReaderStudy``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answerable_questions</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

<div class="viewcode-block" id="ReaderStudy.get_progress_for_user">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.get_progress_for_user">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_progress_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the percentage of completed hangings and questions for ``user``.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;questions&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;hangings&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;diff&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

        <span class="n">n_display_sets</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">n_display_sets</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">answerable_question_count</span>

        <span class="n">answers</span> <span class="o">=</span> <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">question__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">answerable_questions</span><span class="p">,</span>
            <span class="n">creator_id</span><span class="o">=</span><span class="n">user</span><span class="o">.</span><span class="n">id</span><span class="p">,</span>
            <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="n">answer_count</span> <span class="o">=</span> <span class="n">answers</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">expected</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">answer_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;questions&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;hangings&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">,</span> <span class="s2">&quot;diff&quot;</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">}</span>

        <span class="n">completed_hangings</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="n">answers_for_user</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span>
                    <span class="s2">&quot;answers&quot;</span><span class="p">,</span>
                    <span class="nb">filter</span><span class="o">=</span><span class="n">Q</span><span class="p">(</span>
                        <span class="n">answers__creator</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
                        <span class="n">answers__is_ground_truth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">answers_for_user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">answerable_question_count</span><span class="p">)</span>
        <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="n">answer_count</span> <span class="o">/</span> <span class="n">expected</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="n">hangings</span> <span class="o">=</span> <span class="n">completed_hangings</span> <span class="o">/</span> <span class="n">n_display_sets</span> <span class="o">*</span> <span class="mi">100</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;questions&quot;</span><span class="p">:</span> <span class="n">questions</span><span class="p">,</span>
            <span class="s2">&quot;hangings&quot;</span><span class="p">:</span> <span class="n">hangings</span><span class="p">,</span>
            <span class="s2">&quot;diff&quot;</span><span class="p">:</span> <span class="n">questions</span> <span class="o">-</span> <span class="n">hangings</span><span class="p">,</span>
        <span class="p">}</span></div>


    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">questions_with_ground_truth</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">questions</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">gt_count</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;answer&quot;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">Q</span><span class="p">(</span><span class="n">answer__is_ground_truth</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">gt_count__gte</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ground_truth_applicable_questions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answerable_questions</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span>
            <span class="n">answer_type__in</span><span class="o">=</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">get_annotation_types</span><span class="p">()</span>
        <span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ground_truth_count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">question__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_applicable_questions</span><span class="p">,</span>
                <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;display_set&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
            <span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">ground_truth_is_complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">count_gt_viable_questions</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_applicable_questions</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ground_truth_count</span>
            <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">*</span> <span class="n">count_gt_viable_questions</span>
        <span class="p">)</span>

<div class="viewcode-block" id="ReaderStudy.score_for_user">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudy.score_for_user">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">score_for_user</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the average and total score for answers given by ``user``.&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">creator</span><span class="o">=</span><span class="n">user</span><span class="p">,</span>
            <span class="n">question__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">questions_with_ground_truth</span><span class="p">,</span>
            <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="p">)</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">),</span> <span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">))</span></div>


    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">scores_by_user</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The average and total scores for this ``ReaderStudy`` grouped by user.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">question__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">questions_with_ground_truth</span><span class="p">,</span>
                <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;creator_id&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;creator__username&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">),</span> <span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-score__sum&quot;</span><span class="p">)</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">leaderboard</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The leaderboard for this ``ReaderStudy``.&quot;&quot;&quot;</span>
        <span class="n">n_hangings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
        <span class="n">question_count</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answerable_question_count</span><span class="p">)</span> <span class="o">*</span> <span class="n">n_hangings</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;question_count&quot;</span><span class="p">:</span> <span class="n">question_count</span><span class="p">,</span>
            <span class="s2">&quot;grouped_scores&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_by_user</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">statistics</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Statistics per question and case based on the total / average score.&quot;&quot;&quot;</span>
        <span class="n">scores_by_question</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">question__reader_study</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;question_id&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;question__question_text&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">Sum</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">),</span> <span class="n">Avg</span><span class="p">(</span><span class="s2">&quot;score&quot;</span><span class="p">))</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;-score__avg&quot;</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="n">scores_by_case</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">DisplaySet</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">reader_study</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
            <span class="o">.</span><span class="n">select_related</span><span class="p">(</span><span class="s2">&quot;reader_study__workstation__config&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
                <span class="nb">sum</span><span class="o">=</span><span class="n">Sum</span><span class="p">(</span>
                    <span class="s2">&quot;answers__score&quot;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">Q</span><span class="p">(</span><span class="n">answers__is_ground_truth</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">),</span>
                <span class="n">avg</span><span class="o">=</span><span class="n">Avg</span><span class="p">(</span>
                    <span class="s2">&quot;answers__score&quot;</span><span class="p">,</span> <span class="nb">filter</span><span class="o">=</span><span class="n">Q</span><span class="p">(</span><span class="n">answers__is_ground_truth</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="p">),</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;avg&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">all</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="n">options</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">CategoricalOption</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
            <span class="n">question__reader_study</span><span class="o">=</span><span class="bp">self</span>
        <span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">):</span>
            <span class="n">qt</span> <span class="o">=</span> <span class="n">option</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]</span>
            <span class="n">options</span><span class="p">[</span><span class="n">qt</span><span class="p">]</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">qt</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">options</span><span class="p">[</span><span class="n">qt</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">option</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]:</span> <span class="n">option</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]})</span>

        <span class="n">ground_truths</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">questions</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">gt</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">question__reader_study</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">values</span><span class="p">(</span>
                <span class="s2">&quot;display_set_id&quot;</span><span class="p">,</span>
                <span class="s2">&quot;answer&quot;</span><span class="p">,</span>
                <span class="s2">&quot;question&quot;</span><span class="p">,</span>
                <span class="s2">&quot;question__question_text&quot;</span><span class="p">,</span>
                <span class="s2">&quot;question__answer_type&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;question__order&quot;</span><span class="p">,</span> <span class="s2">&quot;question__created&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">questions</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="s2">&quot;question__question_text&quot;</span><span class="p">])</span>

            <span class="n">field</span> <span class="o">=</span> <span class="n">gt</span><span class="p">[</span><span class="s2">&quot;display_set_id&quot;</span><span class="p">]</span>
            <span class="n">ground_truths</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">ground_truths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="p">{})</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">gt</span><span class="p">[</span><span class="s2">&quot;question__answer_type&quot;</span><span class="p">]</span>
                <span class="o">==</span> <span class="n">Question</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span>
            <span class="p">):</span>
                <span class="n">human_readable_answers</span> <span class="o">=</span> <span class="p">[</span>
                    <span class="n">options</span><span class="p">[</span><span class="n">gt</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">gt</span><span class="p">[</span><span class="s2">&quot;answer&quot;</span><span class="p">]</span>
                <span class="p">]</span>
                <span class="n">human_readable_answers</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
                <span class="n">human_readable_answer</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">human_readable_answers</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">human_readable_answer</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">gt</span><span class="p">[</span><span class="s2">&quot;question&quot;</span><span class="p">],</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">gt</span><span class="p">[</span><span class="s2">&quot;answer&quot;</span><span class="p">],</span> <span class="n">gt</span><span class="p">[</span><span class="s2">&quot;answer&quot;</span><span class="p">]</span>
                <span class="p">)</span>

            <span class="n">ground_truths</span><span class="p">[</span><span class="n">field</span><span class="p">][</span>
                <span class="n">gt</span><span class="p">[</span><span class="s2">&quot;question__question_text&quot;</span><span class="p">]</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">human_readable_answer</span>

        <span class="n">questions</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">dict</span><span class="o">.</span><span class="n">fromkeys</span><span class="p">(</span><span class="n">questions</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;max_score_questions&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">all</span><span class="p">()))</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_by_user</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="s2">&quot;scores_by_question&quot;</span><span class="p">:</span> <span class="n">scores_by_question</span><span class="p">,</span>
            <span class="s2">&quot;max_score_cases&quot;</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answerable_question_count</span><span class="p">)</span>
            <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">scores_by_user</span><span class="o">.</span><span class="n">count</span><span class="p">(),</span>
            <span class="s2">&quot;scores_by_case&quot;</span><span class="p">:</span> <span class="n">scores_by_case</span><span class="p">,</span>
            <span class="s2">&quot;ground_truths&quot;</span><span class="p">:</span> <span class="n">ground_truths</span><span class="p">,</span>
            <span class="s2">&quot;questions&quot;</span><span class="p">:</span> <span class="n">questions</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">next_display_set_order</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">last</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>
        <span class="n">highest</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">last</span><span class="p">,</span> <span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">highest</span> <span class="o">+</span> <span class="mi">10</span><span class="p">)</span> <span class="o">//</span> <span class="mi">10</span> <span class="o">*</span> <span class="mi">10</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">civ_sets_list_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;reader-studies:display_sets&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">bulk_delete_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;reader-studies:display-sets-bulk-delete&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">interface_viewname</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;components:component-interface-list-reader-studies&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">list_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span><span class="s2">&quot;reader-studies:list&quot;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">civ_sets_related_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">display_sets</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">civ_set_model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">DisplaySet</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">create_civ_set</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">civ_set_model</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">create</span><span class="p">(</span><span class="n">reader_study</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">data</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_civ_set_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;reader-studies:display-set-create&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">create_civ_set_batch_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;reader-studies:display-sets-create&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">slug</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">linked_component_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">linked_component_interfaces</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="n">ComponentInterface</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                <span class="n">question__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">questions</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
            <span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">credits_consumed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">session</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">session_utilizations</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span>
            <span class="n">num</span><span class="o">=</span><span class="n">Count</span><span class="p">(</span><span class="s2">&quot;reader_studies&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="n">total</span> <span class="o">+=</span> <span class="n">session</span><span class="o">.</span><span class="n">credits_consumed</span> <span class="o">/</span> <span class="n">session</span><span class="o">.</span><span class="n">num</span>
        <span class="k">return</span> <span class="n">ceil</span><span class="p">(</span><span class="n">total</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_launchable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">max_credits</span> <span class="ow">is</span> <span class="kc">None</span>
            <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">credits_consumed</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_credits</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">questions_with_interactive_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">questions</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">interactive_algorithm</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span></div>



<div class="viewcode-block" id="ReaderStudyUserObjectPermission">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudyUserObjectPermission">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ReaderStudyUserObjectPermission</span><span class="p">(</span><span class="n">UserObjectPermissionBase</span><span class="p">):</span>
    <span class="n">allowed_permissions</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>

    <span class="n">content_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">ReaderStudy</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span></div>



<div class="viewcode-block" id="ReaderStudyGroupObjectPermission">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudyGroupObjectPermission">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ReaderStudyGroupObjectPermission</span><span class="p">(</span><span class="n">GroupObjectPermissionBase</span><span class="p">):</span>
    <span class="n">allowed_permissions</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;read_readerstudy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;view_leaderboard&quot;</span><span class="p">,</span>
            <span class="s2">&quot;change_readerstudy&quot;</span><span class="p">,</span>
            <span class="s2">&quot;view_readerstudy&quot;</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>

    <span class="n">content_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">ReaderStudy</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span></div>



<div class="viewcode-block" id="WorkstationSessionReaderStudy">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.WorkstationSessionReaderStudy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">WorkstationSessionReaderStudy</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># Through table for optional hanging protocols</span>
    <span class="c1"># https://docs.djangoproject.com/en/4.2/topics/db/models/#intermediary-manytomany</span>
    <span class="n">reader_study</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">ReaderStudy</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">workstation_session</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;workstations.Session&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;reader_study&quot;</span><span class="p">,</span> <span class="s2">&quot;workstation_session&quot;</span><span class="p">),)</span></div>



<div class="viewcode-block" id="delete_reader_study_groups_hook">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.delete_reader_study_groups_hook">[docs]</a>
<span class="nd">@receiver</span><span class="p">(</span><span class="n">post_delete</span><span class="p">,</span> <span class="n">sender</span><span class="o">=</span><span class="n">ReaderStudy</span><span class="p">)</span>
<span class="k">def</span><span class="w"> </span><span class="nf">delete_reader_study_groups_hook</span><span class="p">(</span><span class="o">*</span><span class="n">_</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">ReaderStudy</span><span class="p">,</span> <span class="n">using</span><span class="p">,</span> <span class="o">**</span><span class="n">__</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Deletes the related groups.</span>

<span class="sd">    We use a signal rather than overriding delete() to catch usages of</span>
<span class="sd">    bulk_delete.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">editors_group</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">instance</span><span class="o">.</span><span class="n">readers_group</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">using</span><span class="o">=</span><span class="n">using</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">ObjectDoesNotExist</span><span class="p">:</span>
        <span class="k">pass</span></div>



<div class="viewcode-block" id="DisplaySet">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.DisplaySet">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DisplaySet</span><span class="p">(</span>
    <span class="n">CIVSetStringRepresentationMixin</span><span class="p">,</span>
    <span class="n">CIVSetObjectPermissionsMixin</span><span class="p">,</span>
    <span class="n">CIVForObjectMixin</span><span class="p">,</span>
    <span class="n">UUIDModel</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">reader_study</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">ReaderStudy</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;display_sets&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span>
    <span class="p">)</span>
    <span class="n">values</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ManyToManyField</span><span class="p">(</span>
        <span class="n">ComponentInterfaceValue</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;display_sets&quot;</span>
    <span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">255</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">assign_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">delete_perm</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">change_perm</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_perm</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">view_perm</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">readers_group</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;created&quot;</span><span class="p">)</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">models</span><span class="o">.</span><span class="n">UniqueConstraint</span><span class="p">(</span>
                <span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="s2">&quot;reader_study&quot;</span><span class="p">],</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unique_display_set_title&quot;</span><span class="p">,</span>
                <span class="n">condition</span><span class="o">=~</span><span class="n">Q</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">),</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_editable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">answers</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">base_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">api_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;API url for this ``DisplaySet``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;api:reader-studies-display-set-detail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="nd">@cached_property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">workstation_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;The URL to answer this display set in a workstation&quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;workstations:workstation-session-create&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">workstation</span><span class="o">.</span><span class="n">slug</span><span class="p">},</span>
        <span class="p">)</span>
        <span class="n">pqs</span> <span class="o">=</span> <span class="n">get_workstation_path_and_query_string</span><span class="p">(</span><span class="n">display_set</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">url</span><span class="si">}{</span><span class="n">pqs</span><span class="o">.</span><span class="n">path</span><span class="si">}</span><span class="s2">?</span><span class="si">{</span><span class="n">pqs</span><span class="o">.</span><span class="n">query_string</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">description</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
        <span class="n">case_text</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">case_text</span>

        <span class="k">if</span> <span class="n">case_text</span><span class="p">:</span>
            <span class="n">seen_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
            <span class="n">output</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

            <span class="k">for</span> <span class="n">val</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">val</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">name</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">continue</span>

                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">case_text</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen_names</span><span class="p">:</span>
                    <span class="n">output</span> <span class="o">+=</span> <span class="n">md2html</span><span class="p">(</span><span class="n">case_text</span><span class="p">[</span><span class="n">name</span><span class="p">])</span>
                    <span class="n">seen_names</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">output</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">standard_index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">display_sets</span><span class="o">.</span><span class="n">all</span><span class="p">()]</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">update_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;reader-studies:display-set-update&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_object</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span> <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;reader-studies:display-set-detail&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_object</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span> <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">delete_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;reader-studies:display-set-delete&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_object</span><span class="o">.</span><span class="n">slug</span><span class="p">,</span> <span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_civ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">civ</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">add_civ</span><span class="p">(</span><span class="n">civ</span><span class="o">=</span><span class="n">civ</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">civ</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">remove_civ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">civ</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">remove_civ</span><span class="p">(</span><span class="n">civ</span><span class="o">=</span><span class="n">civ</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">civ</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_civ_for_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">interface</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">interface</span><span class="o">=</span><span class="n">interface</span><span class="p">)</span></div>



<div class="viewcode-block" id="DisplaySetUserObjectPermission">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.DisplaySetUserObjectPermission">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DisplaySetUserObjectPermission</span><span class="p">(</span><span class="n">UserObjectPermissionBase</span><span class="p">):</span>
    <span class="n">allowed_permissions</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>

    <span class="n">content_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">DisplaySet</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span></div>



<div class="viewcode-block" id="DisplaySetGroupObjectPermission">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.DisplaySetGroupObjectPermission">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">DisplaySetGroupObjectPermission</span><span class="p">(</span><span class="n">GroupObjectPermissionBase</span><span class="p">):</span>
    <span class="n">allowed_permissions</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">(</span>
        <span class="p">{</span><span class="s2">&quot;change_displayset&quot;</span><span class="p">,</span> <span class="s2">&quot;delete_displayset&quot;</span><span class="p">,</span> <span class="s2">&quot;view_displayset&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="n">content_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">DisplaySet</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span></div>



<div class="viewcode-block" id="AnswerType">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.AnswerType">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AnswerType</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TextChoices</span><span class="p">):</span>
    <span class="c1"># WARNING: Do not change the display text, these are used in the front end</span>
    <span class="n">TEXT</span> <span class="o">=</span> <span class="s2">&quot;TEXT&quot;</span><span class="p">,</span> <span class="s2">&quot;Text&quot;</span>
    <span class="n">BOOL</span> <span class="o">=</span> <span class="s2">&quot;BOOL&quot;</span><span class="p">,</span> <span class="s2">&quot;Bool&quot;</span>
    <span class="n">NUMBER</span> <span class="o">=</span> <span class="s2">&quot;NUMB&quot;</span><span class="p">,</span> <span class="s2">&quot;Number&quot;</span>
    <span class="n">HEADING</span> <span class="o">=</span> <span class="s2">&quot;HEAD&quot;</span><span class="p">,</span> <span class="s2">&quot;Heading&quot;</span>
    <span class="n">BOUNDING_BOX_2D</span> <span class="o">=</span> <span class="s2">&quot;2DBB&quot;</span><span class="p">,</span> <span class="s2">&quot;2D bounding box&quot;</span>
    <span class="n">MULTIPLE_2D_BOUNDING_BOXES</span> <span class="o">=</span> <span class="s2">&quot;M2DB&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple 2D bounding boxes&quot;</span>
    <span class="n">DISTANCE_MEASUREMENT</span> <span class="o">=</span> <span class="s2">&quot;DIST&quot;</span><span class="p">,</span> <span class="s2">&quot;Distance measurement&quot;</span>
    <span class="n">MULTIPLE_DISTANCE_MEASUREMENTS</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;MDIS&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple distance measurements&quot;</span><span class="p">)</span>
    <span class="n">POINT</span> <span class="o">=</span> <span class="s2">&quot;POIN&quot;</span><span class="p">,</span> <span class="s2">&quot;Point&quot;</span>
    <span class="n">MULTIPLE_POINTS</span> <span class="o">=</span> <span class="s2">&quot;MPOI&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple points&quot;</span>
    <span class="n">POLYGON</span> <span class="o">=</span> <span class="s2">&quot;POLY&quot;</span><span class="p">,</span> <span class="s2">&quot;Polygon&quot;</span>
    <span class="n">MULTIPLE_POLYGONS</span> <span class="o">=</span> <span class="s2">&quot;MPOL&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple polygons&quot;</span>
    <span class="n">CHOICE</span> <span class="o">=</span> <span class="s2">&quot;CHOI&quot;</span><span class="p">,</span> <span class="s2">&quot;Choice&quot;</span>
    <span class="n">MULTIPLE_CHOICE</span> <span class="o">=</span> <span class="s2">&quot;MCHO&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple choice&quot;</span>
    <span class="n">MASK</span> <span class="o">=</span> <span class="s2">&quot;MASK&quot;</span><span class="p">,</span> <span class="s2">&quot;Mask&quot;</span>
    <span class="n">LINE</span> <span class="o">=</span> <span class="s2">&quot;LINE&quot;</span><span class="p">,</span> <span class="s2">&quot;Line&quot;</span>
    <span class="n">MULTIPLE_LINES</span> <span class="o">=</span> <span class="s2">&quot;MLIN&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple lines&quot;</span>
    <span class="n">ANGLE</span> <span class="o">=</span> <span class="s2">&quot;ANGL&quot;</span><span class="p">,</span> <span class="s2">&quot;Angle&quot;</span>
    <span class="n">MULTIPLE_ANGLES</span> <span class="o">=</span> <span class="s2">&quot;MANG&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple angles&quot;</span>
    <span class="n">ELLIPSE</span> <span class="o">=</span> <span class="s2">&quot;ELLI&quot;</span><span class="p">,</span> <span class="s2">&quot;Ellipse&quot;</span>
    <span class="n">MULTIPLE_ELLIPSES</span> <span class="o">=</span> <span class="s2">&quot;MELL&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple ellipses&quot;</span>
    <span class="n">THREE_POINT_ANGLE</span> <span class="o">=</span> <span class="s2">&quot;3ANG&quot;</span><span class="p">,</span> <span class="s2">&quot;Three-point angle&quot;</span>
    <span class="n">MULTIPLE_THREE_POINT_ANGLES</span> <span class="o">=</span> <span class="s2">&quot;M3AN&quot;</span><span class="p">,</span> <span class="s2">&quot;Multiple three-point angles&quot;</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_choice_types</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_annotation_types</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOUNDING_BOX_2D</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_2D_BOUNDING_BOXES</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">DISTANCE_MEASUREMENT</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_DISTANCE_MEASUREMENTS</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">POINT</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POINTS</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POLYGONS</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MASK</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">LINE</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_LINES</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ANGLES</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">ELLIPSE</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ELLIPSES</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">THREE_POINT_ANGLE</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_THREE_POINT_ANGLES</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_image_types</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">MASK</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_widget_required_types</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">,</span>
        <span class="p">]</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">get_non_answerable_types</span><span class="p">():</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">HEADING</span><span class="p">]</span></div>



<span class="n">ANSWER_TYPE_TO_INTERFACE_KIND_MAP</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">STRING</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOOL</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">BOOL</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">FLOAT</span><span class="p">,</span>
        <span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">INTEGER</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">HEADING</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOUNDING_BOX_2D</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">TWO_D_BOUNDING_BOX</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_2D_BOUNDING_BOXES</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">MULTIPLE_TWO_D_BOUNDING_BOXES</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">DISTANCE_MEASUREMENT</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">DISTANCE_MEASUREMENT</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_DISTANCE_MEASUREMENTS</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">MULTIPLE_DISTANCE_MEASUREMENTS</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">POINT</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">POINT</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POINTS</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">MULTIPLE_POINTS</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POLYGONS</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">MULTIPLE_POLYGONS</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">LINE</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">LINE</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_LINES</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">MULTIPLE_LINES</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MASK</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">PANIMG_SEGMENTATION</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ANGLES</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">MULTIPLE_ANGLES</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">ELLIPSE</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">ELLIPSE</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ELLIPSES</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">MULTIPLE_ELLIPSES</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">THREE_POINT_ANGLE</span><span class="p">:</span> <span class="p">[</span><span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">THREE_POINT_ANGLE</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_THREE_POINT_ANGLES</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">InterfaceKindChoices</span><span class="o">.</span><span class="n">MULTIPLE_THREE_POINT_ANGLES</span>
    <span class="p">],</span>
<span class="p">}</span>


<div class="viewcode-block" id="QuestionWidgetKindChoices">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.QuestionWidgetKindChoices">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QuestionWidgetKindChoices</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TextChoices</span><span class="p">):</span>
    <span class="n">ACCEPT_REJECT</span> <span class="o">=</span> <span class="s2">&quot;ACCEPT_REJECT&quot;</span><span class="p">,</span> <span class="s2">&quot;Accept/Reject Findings&quot;</span>
    <span class="n">NUMBER_INPUT</span> <span class="o">=</span> <span class="s2">&quot;NUMBER_INPUT&quot;</span><span class="p">,</span> <span class="s2">&quot;Number Input&quot;</span>
    <span class="n">NUMBER_RANGE</span> <span class="o">=</span> <span class="s2">&quot;NUMBER_RANGE&quot;</span><span class="p">,</span> <span class="s2">&quot;Number Range&quot;</span>
    <span class="n">TEXT_INPUT</span> <span class="o">=</span> <span class="s2">&quot;TEXT_INPUT&quot;</span><span class="p">,</span> <span class="s2">&quot;Text Input&quot;</span>
    <span class="n">TEXT_AREA</span> <span class="o">=</span> <span class="s2">&quot;TEXT_AREA&quot;</span><span class="p">,</span> <span class="s2">&quot;Text Area&quot;</span>
    <span class="n">SELECT_MULTIPLE</span> <span class="o">=</span> <span class="s2">&quot;SELECT_MULTIPLE&quot;</span><span class="p">,</span> <span class="s2">&quot;Select Multiple&quot;</span>
    <span class="n">CHECKBOX_SELECT_MULTIPLE</span> <span class="o">=</span> <span class="p">(</span>
        <span class="s2">&quot;CHECKBOX_SELECT_MULTIPLE&quot;</span><span class="p">,</span>
        <span class="s2">&quot;Checkbox Select Multiple&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">SELECT</span> <span class="o">=</span> <span class="s2">&quot;SELECT&quot;</span><span class="p">,</span> <span class="s2">&quot;Select&quot;</span>
    <span class="n">RADIO_SELECT</span> <span class="o">=</span> <span class="s2">&quot;RADIO_SELECT&quot;</span><span class="p">,</span> <span class="s2">&quot;Radio Select&quot;</span></div>



<span class="n">ANSWER_TYPE_TO_QUESTION_WIDGET</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">TEXT_INPUT</span><span class="p">,</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">TEXT_AREA</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOOL</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">NUMBER_INPUT</span><span class="p">,</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">NUMBER_RANGE</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">HEADING</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOUNDING_BOX_2D</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_2D_BOUNDING_BOXES</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">ACCEPT_REJECT</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">DISTANCE_MEASUREMENT</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_DISTANCE_MEASUREMENTS</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">ACCEPT_REJECT</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">POINT</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POINTS</span><span class="p">:</span> <span class="p">[</span><span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">ACCEPT_REJECT</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POLYGONS</span><span class="p">:</span> <span class="p">[</span><span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">ACCEPT_REJECT</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">RADIO_SELECT</span><span class="p">,</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">SELECT</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">CHECKBOX_SELECT_MULTIPLE</span><span class="p">,</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">SELECT_MULTIPLE</span><span class="p">,</span>
    <span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MASK</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">LINE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_LINES</span><span class="p">:</span> <span class="p">[</span><span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">ACCEPT_REJECT</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ANGLES</span><span class="p">:</span> <span class="p">[</span><span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">ACCEPT_REJECT</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">ELLIPSE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ELLIPSES</span><span class="p">:</span> <span class="p">[</span><span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">ACCEPT_REJECT</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">THREE_POINT_ANGLE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_THREE_POINT_ANGLES</span><span class="p">:</span> <span class="p">[</span>
        <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">ACCEPT_REJECT</span>
    <span class="p">],</span>
<span class="p">}</span>

<span class="n">ANSWER_TYPE_TO_QUESTION_WIDGET_CHOICES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">answer_type</span><span class="p">:</span> <span class="p">[(</span><span class="n">option</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">answer_type</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">ANSWER_TYPE_TO_QUESTION_WIDGET</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>

<span class="n">EMPTY_ANSWER_VALUES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOOL</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOUNDING_BOX_2D</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_2D_BOUNDING_BOXES</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">DISTANCE_MEASUREMENT</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_DISTANCE_MEASUREMENTS</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">POINT</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POINTS</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POLYGONS</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">LINE</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_LINES</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MASK</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ANGLES</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">ELLIPSE</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ELLIPSES</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">THREE_POINT_ANGLE</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_THREE_POINT_ANGLES</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">}</span>

<span class="n">ANSWER_TYPE_TO_INTERACTIVE_ALGORITHM</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">HEADING</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOOL</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOUNDING_BOX_2D</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_2D_BOUNDING_BOXES</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">DISTANCE_MEASUREMENT</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_DISTANCE_MEASUREMENTS</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">POINT</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POINTS</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">POLYGON</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_POLYGONS</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">LINE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_LINES</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MASK</span><span class="p">:</span> <span class="p">[</span><span class="n">InteractiveAlgorithmChoices</span><span class="o">.</span><span class="n">ULS23_BASELINE</span><span class="p">],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">ANGLE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ANGLES</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">ELLIPSE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_ELLIPSES</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">THREE_POINT_ANGLE</span><span class="p">:</span> <span class="p">[],</span>
    <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_THREE_POINT_ANGLES</span><span class="p">:</span> <span class="p">[],</span>
<span class="p">}</span>

<span class="n">ANSWER_TYPE_TO_INTERACTIVE_ALGORITHM_CHOICES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">answer_type</span><span class="p">:</span> <span class="p">[(</span><span class="n">option</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">option</span><span class="o">.</span><span class="n">label</span><span class="p">)</span> <span class="k">for</span> <span class="n">option</span> <span class="ow">in</span> <span class="n">options</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">answer_type</span><span class="p">,</span> <span class="n">options</span> <span class="ow">in</span> <span class="n">ANSWER_TYPE_TO_INTERACTIVE_ALGORITHM</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
<span class="p">}</span>


<div class="viewcode-block" id="ImagePort">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ImagePort">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ImagePort</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TextChoices</span><span class="p">):</span>
    <span class="n">MAIN</span> <span class="o">=</span> <span class="s2">&quot;M&quot;</span><span class="p">,</span> <span class="s2">&quot;Main&quot;</span>
    <span class="n">SECONDARY</span> <span class="o">=</span> <span class="s2">&quot;S&quot;</span><span class="p">,</span> <span class="s2">&quot;Secondary&quot;</span>
    <span class="n">TERTIARY</span> <span class="o">=</span> <span class="s2">&quot;TERTIARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Tertiary&quot;</span>
    <span class="n">QUATERNARY</span> <span class="o">=</span> <span class="s2">&quot;QUATERNARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Quaternary&quot;</span>
    <span class="n">QUINARY</span> <span class="o">=</span> <span class="s2">&quot;QUINARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Quinary&quot;</span>
    <span class="n">SENARY</span> <span class="o">=</span> <span class="s2">&quot;SENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Senary&quot;</span>
    <span class="n">SEPTENARY</span> <span class="o">=</span> <span class="s2">&quot;SEPTENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Septenary&quot;</span>
    <span class="n">OCTONARY</span> <span class="o">=</span> <span class="s2">&quot;OCTONARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Octonary&quot;</span>
    <span class="n">NONARY</span> <span class="o">=</span> <span class="s2">&quot;NONARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Nonary&quot;</span>
    <span class="n">DENARY</span> <span class="o">=</span> <span class="s2">&quot;DENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Denary&quot;</span>
    <span class="n">UNDENARY</span> <span class="o">=</span> <span class="s2">&quot;UNDENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Undenary&quot;</span>
    <span class="n">DUODENARY</span> <span class="o">=</span> <span class="s2">&quot;DUODENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Duodenary&quot;</span>
    <span class="n">TREDENARY</span> <span class="o">=</span> <span class="s2">&quot;TREDENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Tredenary&quot;</span>
    <span class="n">QUATTUORDENARY</span> <span class="o">=</span> <span class="s2">&quot;QUATTUORDENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Quattuordenary&quot;</span>
    <span class="n">QUINDENARY</span> <span class="o">=</span> <span class="s2">&quot;QUINDENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Quindenary&quot;</span>
    <span class="n">SEXDENARY</span> <span class="o">=</span> <span class="s2">&quot;SEXDENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Sexdenary&quot;</span>
    <span class="n">SEPTENDENARY</span> <span class="o">=</span> <span class="s2">&quot;SEPTENDENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Septendenary&quot;</span>
    <span class="n">OCTODENARY</span> <span class="o">=</span> <span class="s2">&quot;OCTODENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Octodenary&quot;</span>
    <span class="n">NOVEMDENARY</span> <span class="o">=</span> <span class="s2">&quot;NOVEMDENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Novemdenary&quot;</span>
    <span class="n">VIGINTENARY</span> <span class="o">=</span> <span class="s2">&quot;VIGINTENARY&quot;</span><span class="p">,</span> <span class="s2">&quot;Vigintenary&quot;</span></div>



<span class="c1"># This was redefined in the hanging protocol app and not unified</span>
<span class="n">IMAGE_PORT_TO_VIEWPORT_NAME</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">MAIN</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">main</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">SECONDARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">secondary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">TERTIARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">tertiary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">QUATERNARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">quaternary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">QUINARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">quinary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">SENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">senary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">SEPTENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">septenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">OCTONARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">octonary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">NONARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">nonary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">DENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">denary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">UNDENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">undenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">DUODENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">duodenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">TREDENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">tredenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">QUATTUORDENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">quattuordenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">QUINDENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">quindenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">SEXDENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">sexdenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">SEPTENDENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">septendenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">OCTODENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">octodenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">NOVEMDENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">novemdenary</span><span class="p">,</span>
    <span class="n">ImagePort</span><span class="o">.</span><span class="n">VIGINTENARY</span><span class="p">:</span> <span class="n">ViewportNames</span><span class="o">.</span><span class="n">vigintenary</span><span class="p">,</span>
<span class="p">}</span>


<div class="viewcode-block" id="Question">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Question">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Question</span><span class="p">(</span><span class="n">UUIDModel</span><span class="p">,</span> <span class="n">OverlaySegmentsMixin</span><span class="p">):</span>
    <span class="n">AnswerType</span> <span class="o">=</span> <span class="n">AnswerType</span>
    <span class="n">ImagePort</span> <span class="o">=</span> <span class="n">ImagePort</span>

    <span class="c1"># What is the orientation of the question form when presented on the</span>
    <span class="c1"># front end?</span>
<div class="viewcode-block" id="Question.Direction">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Question.Direction">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">Direction</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TextChoices</span><span class="p">):</span>
        <span class="n">HORIZONTAL</span> <span class="o">=</span> <span class="s2">&quot;H&quot;</span><span class="p">,</span> <span class="s2">&quot;Horizontal&quot;</span>
        <span class="n">VERTICAL</span> <span class="o">=</span> <span class="s2">&quot;V&quot;</span><span class="p">,</span> <span class="s2">&quot;Vertical&quot;</span></div>


<div class="viewcode-block" id="Question.ScoringFunction">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Question.ScoringFunction">[docs]</a>
    <span class="k">class</span><span class="w"> </span><span class="nc">ScoringFunction</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">TextChoices</span><span class="p">):</span>
        <span class="n">ACCURACY</span> <span class="o">=</span> <span class="s2">&quot;ACC&quot;</span><span class="p">,</span> <span class="s2">&quot;Accuracy score&quot;</span></div>


    <span class="n">SCORING_FUNCTIONS</span> <span class="o">=</span> <span class="p">{</span><span class="n">ScoringFunction</span><span class="o">.</span><span class="n">ACCURACY</span><span class="p">:</span> <span class="n">accuracy_score</span><span class="p">}</span>

    <span class="n">EXAMPLE_FOR_ANSWER_TYPE</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">AnswerType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span> <span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">answer</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
        <span class="n">AnswerType</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">:</span> <span class="s2">&quot;&#39;1&#39;&quot;</span><span class="p">,</span>
        <span class="n">AnswerType</span><span class="o">.</span><span class="n">BOOL</span><span class="p">:</span> <span class="s2">&quot;&#39;true&#39;&quot;</span><span class="p">,</span>
        <span class="n">AnswerType</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">:</span> <span class="s2">&quot;&#39;</span><span class="se">\&quot;</span><span class="s2">option</span><span class="se">\&quot;</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
        <span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">:</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">[&quot;option1&quot;, &quot;option2&quot;]</span><span class="se">\&#39;</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">reader_study</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">ReaderStudy</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;questions&quot;</span>
    <span class="p">)</span>
    <span class="n">question_text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">()</span>
    <span class="n">help_text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">answer_type</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="c1"># Set blank because the requirement is dependent on answer_type and handled in the front end</span>
    <span class="n">image_port</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">ImagePort</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="p">)</span>
    <span class="n">default_annotation_color</span> <span class="o">=</span> <span class="n">HexColorField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Default color for displaying and creating annotations for this question&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">required</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">direction</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">choices</span><span class="o">=</span><span class="n">Direction</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">Direction</span><span class="o">.</span><span class="n">HORIZONTAL</span>
    <span class="p">)</span>
    <span class="n">scoring_function</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">ScoringFunction</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="n">ScoringFunction</span><span class="o">.</span><span class="n">ACCURACY</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">interface</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">ComponentInterface</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">widget</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">24</span><span class="p">,</span> <span class="n">blank</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">interactive_algorithm</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span>
        <span class="n">choices</span><span class="o">=</span><span class="n">InteractiveAlgorithmChoices</span><span class="o">.</span><span class="n">choices</span><span class="p">,</span>
        <span class="n">max_length</span><span class="o">=</span><span class="mi">32</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Which interactive algorithm should be used for this question?&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">answer_max_value</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallIntegerField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Maximum value for answers of type Number. Can only be set in combination with the &#39;Number input&#39; or &#39;Number Range&#39; widgets.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">answer_min_value</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">SmallIntegerField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Minimum value for answers of type Number. Can only be set in combination with the &#39;Number input&#39; or &#39;Number Range&#39; widgets.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">answer_step_size</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DecimalField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">max_digits</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span>
        <span class="n">decimal_places</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
        <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">MinValueValidator</span><span class="p">(</span><span class="n">limit_value</span><span class="o">=</span><span class="mf">0.001</span><span class="p">)],</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Step size for answers of type Number. Defaults to 1, allowing only integer values. Can only be set in combination with the &#39;Number input&#39; or &#39;Number Range&#39; widgets.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">answer_min_length</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Minimum length for answers of type Text. Can only be set in combination with the &#39;Text Input&#39; or &#39;Text Area&#39; widgets.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">answer_max_length</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">PositiveSmallIntegerField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Maximum length for answers of type Text. Can only be set in combination with the &#39;Text Input&#39; or &#39;Text Area&#39; widgets.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">answer_match_pattern</span> <span class="o">=</span> <span class="n">RegexField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Regular expression to match a pattern for answers of type Text. Can only be set in combination with the &#39;Text Input&#39; or &#39;Text Area&#39; widgets.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">empty_answer_confirmation</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Require an explicit confirmation when saving an empty answer to this question.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">empty_answer_confirmation_label</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;Label to show when confirming an empty answer.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;order&quot;</span><span class="p">,</span> <span class="s2">&quot;created&quot;</span><span class="p">)</span>
        <span class="n">permissions</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span>
                <span class="s2">&quot;add_interactive_algorithm_to_question&quot;</span><span class="p">,</span>
                <span class="s2">&quot;Can add interactive algorithm to question&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">]</span>

    <span class="n">copy_fields</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;question_text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;help_text&quot;</span><span class="p">,</span>
        <span class="s2">&quot;answer_type&quot;</span><span class="p">,</span>
        <span class="s2">&quot;image_port&quot;</span><span class="p">,</span>
        <span class="s2">&quot;default_annotation_color&quot;</span><span class="p">,</span>
        <span class="s2">&quot;required&quot;</span><span class="p">,</span>
        <span class="s2">&quot;direction&quot;</span><span class="p">,</span>
        <span class="s2">&quot;scoring_function&quot;</span><span class="p">,</span>
        <span class="s2">&quot;order&quot;</span><span class="p">,</span>
        <span class="s2">&quot;interface&quot;</span><span class="p">,</span>
        <span class="s2">&quot;look_up_table&quot;</span><span class="p">,</span>
        <span class="s2">&quot;overlay_segments&quot;</span><span class="p">,</span>
        <span class="s2">&quot;widget&quot;</span><span class="p">,</span>
        <span class="s2">&quot;interactive_algorithm&quot;</span><span class="p">,</span>
        <span class="s2">&quot;answer_max_value&quot;</span><span class="p">,</span>
        <span class="s2">&quot;answer_min_value&quot;</span><span class="p">,</span>
        <span class="s2">&quot;answer_step_size&quot;</span><span class="p">,</span>
        <span class="s2">&quot;answer_min_length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;answer_max_length&quot;</span><span class="p">,</span>
        <span class="s2">&quot;answer_match_pattern&quot;</span><span class="p">,</span>
        <span class="s2">&quot;empty_answer_confirmation&quot;</span><span class="p">,</span>
        <span class="s2">&quot;empty_answer_confirmation_label&quot;</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">question_text</span><span class="si">}</span><span class="s2"> &quot;</span>
            <span class="s2">&quot;(&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_answer_type_display</span><span class="p">()</span><span class="si">}</span><span class="s2">, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_port_display</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="s1">&#39; port,&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">image_port</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;not&#39;</span><span class="si">}</span><span class="s2"> required, &quot;</span>
            <span class="sa">f</span><span class="s2">&quot;order </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">order</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="s2">&quot;)&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">api_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;API url for this ``Question``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;api:reader-studies-question-detail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_fully_editable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;``True`` if no ``Answer`` has been given for this ``Question``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_set</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">read_only_fields</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_fully_editable</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span>
                <span class="s2">&quot;question_text&quot;</span><span class="p">,</span>
                <span class="s2">&quot;answer_type&quot;</span><span class="p">,</span>
                <span class="s2">&quot;image_port&quot;</span><span class="p">,</span>
                <span class="s2">&quot;required&quot;</span><span class="p">,</span>
                <span class="s2">&quot;overlay_segments&quot;</span><span class="p">,</span>
                <span class="s2">&quot;widget&quot;</span><span class="p">,</span>
                <span class="s2">&quot;answer_min_value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;answer_max_value&quot;</span><span class="p">,</span>
                <span class="s2">&quot;answer_step_size&quot;</span><span class="p">,</span>
                <span class="s2">&quot;answer_min_length&quot;</span><span class="p">,</span>
                <span class="s2">&quot;answer_max_length&quot;</span><span class="p">,</span>
                <span class="s2">&quot;answer_match_pattern&quot;</span><span class="p">,</span>
                <span class="s2">&quot;interface&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">example_answer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">EXAMPLE_FOR_ANSWER_TYPE</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">,</span> <span class="s2">&quot;&lt;NO EXAMPLE YET&gt;&quot;</span>
        <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">allowed_component_interfaces</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">allowed_interfaces</span> <span class="o">=</span> <span class="n">ANSWER_TYPE_TO_INTERFACE_KIND_MAP</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">ComponentInterface</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">kind__in</span><span class="o">=</span><span class="n">allowed_interfaces</span><span class="p">)</span>

<div class="viewcode-block" id="Question.calculate_score">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Question.calculate_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">answer</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the score for ``answer`` by applying ``scoring_function``</span>
<span class="sd">        to ``answer`` and ``ground_truth``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="o">==</span> <span class="n">Question</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.0</span>

            <span class="n">elements</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">answer</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">))</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">elements</span>
            <span class="n">gt</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">elements</span>

            <span class="n">ans</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">answer</span><span class="p">)]</span> <span class="o">=</span> <span class="n">answer</span>
            <span class="n">gt</span><span class="p">[:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ground_truth</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ground_truth</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ans</span> <span class="o">=</span> <span class="p">[</span><span class="n">answer</span><span class="p">]</span>
            <span class="n">gt</span> <span class="o">=</span> <span class="p">[</span><span class="n">ground_truth</span><span class="p">]</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">SCORING_FUNCTIONS</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">scoring_function</span><span class="p">](</span><span class="n">gt</span><span class="p">,</span> <span class="n">ans</span><span class="p">)</span></div>


<div class="viewcode-block" id="Question.save">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Question.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">adding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">adding</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assign_permissions</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">assign_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Allow the editors and readers groups to view this question</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;view_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;view_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">_meta</span><span class="o">.</span><span class="n">model_name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">readers_group</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>

<div class="viewcode-block" id="Question.clean">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Question.clean">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_answer_type</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_empty_answer_confirmation</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_interface</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_image_port</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_widget</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_widget_options</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_interactive_algorithm</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_answer_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Make sure that the image port is only set when using drawn</span>
        <span class="c1"># annotations.</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">get_annotation_types</span><span class="p">()</span>
        <span class="p">)</span> <span class="o">!=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">image_port</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;The image port must (only) be set for annotation questions&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">BOOL</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">HEADING</span><span class="p">]</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Bool or Heading answer types cannot not be Required &quot;</span>
                <span class="s2">&quot;(otherwise the user will need to tick a box for each image!)&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">default_annotation_color</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">get_annotation_types</span><span class="p">()</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Default annotation color should only be set for annotation questions&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_empty_answer_confirmation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_answer_confirmation</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Cannot have answer confirmation and have a question be &quot;</span>
                <span class="s2">&quot;required at the same time&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span>
            <span class="o">*</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">get_annotation_types</span><span class="p">(),</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">NUMBER</span><span class="p">,</span>
            <span class="n">AnswerType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Empty answer confirmation is not supported for &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_answer_type_display</span><span class="p">()</span><span class="si">}</span><span class="s2"> type questions. &quot;</span>
                <span class="s2">&quot;For (Multiple) Choice types, you can add an empty option &quot;</span>
                <span class="s2">&quot;and make the question required&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_interface</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interface</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">allowed_component_interfaces</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The socket </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="si">}</span><span class="s2"> is not allowed for this &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;question type (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="si">}</span><span class="s2">)&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_image_port</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_port</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">view_content</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">viewport_content</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">view_content</span><span class="p">[</span>
                    <span class="n">IMAGE_PORT_TO_VIEWPORT_NAME</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">image_port</span><span class="p">]</span>
                <span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_port_display</span><span class="p">()</span><span class="si">}</span><span class="s2"> view port has not been defined. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Please update the view content of this reader study or select a different view port for question </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="p">(</span>
                <span class="n">ComponentInterface</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">slug__in</span><span class="o">=</span><span class="n">viewport_content</span><span class="p">,</span>
                    <span class="n">kind__in</span><span class="o">=</span><span class="n">InterfaceKinds</span><span class="o">.</span><span class="n">image</span><span class="p">,</span>
                <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
                <span class="o">&lt;</span> <span class="mi">1</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_port_display</span><span class="p">()</span><span class="si">}</span><span class="s2"> view port does not contain an image. &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;Please update the view content of this reader study or select a different view port for question </span><span class="si">{</span><span class="bp">self</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_widget</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">widget</span>
                <span class="ow">not</span> <span class="ow">in</span> <span class="n">ANSWER_TYPE_TO_QUESTION_WIDGET</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">]</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;For questions with answer type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="si">}</span><span class="s2"> you can only &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;enable the following widgets: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">oxford_comma</span><span class="p">(</span><span class="n">ANSWER_TYPE_TO_QUESTION_WIDGET</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">])</span><span class="si">}</span><span class="s2">.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">==</span> <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">ACCEPT_REJECT</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">interface</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;In order to use the </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_widget_display</span><span class="p">()</span><span class="si">}</span><span class="s2"> widget, &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;you need to provide a default answer.&quot;</span>
                    <span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">get_widget_required_types</span><span class="p">():</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The question type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">get_answer_type_display</span><span class="p">()</span><span class="si">}</span><span class="s2"> requires a widget.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_widget_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_number_options</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clean_text_options</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_number_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">is_step_size_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_step_size</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">is_min_value_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">is_max_value_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">is_number_validation_set</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">[</span><span class="n">is_step_size_set</span><span class="p">,</span> <span class="n">is_min_value_set</span><span class="p">,</span> <span class="n">is_max_value_set</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="n">is_range_configured</span> <span class="o">=</span> <span class="nb">all</span><span class="p">(</span>
            <span class="p">[</span><span class="n">is_step_size_set</span><span class="p">,</span> <span class="n">is_min_value_set</span><span class="p">,</span> <span class="n">is_max_value_set</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">perform_number_validation</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="o">==</span> <span class="n">AnswerType</span><span class="o">.</span><span class="n">NUMBER</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">widget</span>
            <span class="ow">in</span> <span class="p">(</span>
                <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">NUMBER_INPUT</span><span class="p">,</span>
                <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">NUMBER_RANGE</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_number_validation_set</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">perform_number_validation</span><span class="p">:</span>
            <span class="c1"># Server side number validation can only be done with AnswerType.NUMBER.</span>
            <span class="c1"># Currently, client side number validation is only done with</span>
            <span class="c1"># QuestionWidgetKindChoices.NUMBER_INPUT or NUMBER_RANGE. If we</span>
            <span class="c1"># allowed number validation with other widgets here the readers may</span>
            <span class="c1"># not get feedback from the viewer about why their answers are rejected</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Min and max values and the step size for answers &quot;</span>
                <span class="s2">&quot;can only be defined in combination with the &quot;</span>
                <span class="s2">&quot;Number Input or Number Range widgets for answers of type Number.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">widget</span> <span class="o">==</span> <span class="n">QuestionWidgetKindChoices</span><span class="o">.</span><span class="n">NUMBER_RANGE</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_range_configured</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Number Range widget requires answer min, max and step values to be set.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">is_min_value_set</span>
            <span class="ow">and</span> <span class="n">is_max_value_set</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_max_value</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_min_value</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Answer max value needs to be bigger than answer min value.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_text_options</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">is_min_length_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_min_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">is_max_length_set</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="n">is_pattern_match_set</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_match_pattern</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span>

        <span class="n">is_text_validation_set</span> <span class="o">=</span> <span class="nb">any</span><span class="p">(</span>
            <span class="p">[</span><span class="n">is_min_length_set</span><span class="p">,</span> <span class="n">is_max_length_set</span><span class="p">,</span> <span class="n">is_pattern_match_set</span><span class="p">]</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">is_text_validation_set</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="o">==</span> <span class="n">AnswerType</span><span class="o">.</span><span class="n">TEXT</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Minimum length, maximum length, and/or pattern match for answers &quot;</span>
                <span class="s2">&quot;can only be defined for the answers of type Text.&quot;</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span>
            <span class="n">is_min_length_set</span>
            <span class="ow">and</span> <span class="n">is_max_length_set</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_max_length</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_min_length</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Answer max length needs to be bigger than answer min length.&quot;</span>
            <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_clean_interactive_algorithm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">interactive_algorithm</span>
            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">interactive_algorithm</span>
            <span class="ow">not</span> <span class="ow">in</span> <span class="n">ANSWER_TYPE_TO_INTERACTIVE_ALGORITHM</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">]</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">interactive_algorithm</span><span class="si">}</span><span class="s2"> is not a valid option for answer type </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">empty_answer_value</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Returns the answer value which is considered to be empty&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">EMPTY_ANSWER_VALUES</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="si">}</span><span class="s2"> has no representation of an empty value.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">EMPTY_ANSWER_VALUES</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="p">]</span>

<div class="viewcode-block" id="Question.is_answer_valid">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Question.is_answer_valid">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_answer_valid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">answer</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validates ``answer`` against ``ANSWER_TYPE_SCHEMA``.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="o">==</span> <span class="n">Question</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">HEADING</span><span class="p">:</span>  <span class="c1"># Never valid</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="n">allowed_types</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;#/definitions/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">}]</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">empty_answer_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">allowed_types</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/null&quot;</span><span class="p">})</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="n">JSONValidator</span><span class="p">(</span>
                    <span class="n">schema</span><span class="o">=</span><span class="p">{</span><span class="o">**</span><span class="n">ANSWER_TYPE_SCHEMA</span><span class="p">,</span> <span class="s2">&quot;anyOf&quot;</span><span class="p">:</span> <span class="n">allowed_types</span><span class="p">}</span>
                <span class="p">)(</span><span class="n">answer</span><span class="p">)</span>
                <span class="ow">is</span> <span class="kc">None</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="n">ValidationError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">except</span> <span class="n">Unresolvable</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;#/definitions/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span><span class="si">}</span><span class="s2"> needs to be defined in &quot;</span>
                <span class="s2">&quot;ANSWER_TYPE_SCHEMA.&quot;</span>
            <span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validators</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_min_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">MinValueValidator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_min_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_max_value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">MaxValueValidator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_max_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_step_size</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">StepValueValidator</span><span class="p">(</span>
                <span class="n">limit_value</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_step_size</span><span class="p">,</span>
                <span class="n">offset</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_min_value</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_min_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">MinLengthValidator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_min_length</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_max_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">MaxLengthValidator</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_max_length</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_match_pattern</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">RegexValidator</span><span class="p">(</span>
                <span class="n">regex</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">answer_match_pattern</span><span class="p">,</span>
                <span class="n">message</span><span class="o">=</span><span class="s2">&quot;Enter a valid answer that matches with the requested format&quot;</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">is_image_type</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer_type</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">get_image_types</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_absolute_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">get_absolute_url</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;#questions&quot;</span></div>



<div class="viewcode-block" id="QuestionUserObjectPermission">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.QuestionUserObjectPermission">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QuestionUserObjectPermission</span><span class="p">(</span><span class="n">UserObjectPermissionBase</span><span class="p">):</span>
    <span class="n">allowed_permissions</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">()</span>

    <span class="n">content_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span></div>



<div class="viewcode-block" id="QuestionGroupObjectPermission">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.QuestionGroupObjectPermission">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">QuestionGroupObjectPermission</span><span class="p">(</span><span class="n">GroupObjectPermissionBase</span><span class="p">):</span>
    <span class="n">allowed_permissions</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;view_question&quot;</span><span class="p">})</span>

    <span class="n">content_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span></div>



<div class="viewcode-block" id="CategoricalOption">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.CategoricalOption">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">CategoricalOption</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">Question</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;options&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
    <span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">1024</span><span class="p">)</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">title</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="s1">&#39;&#39;</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;not &#39;</span><span class="si">}</span><span class="s2">default)&quot;</span></div>



<div class="viewcode-block" id="Answer">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Answer">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">Answer</span><span class="p">(</span><span class="n">UUIDModel</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    An ``Answer`` can be provided to a ``Question`` that is a part of a</span>
<span class="sd">    ``ReaderStudy``.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># TODO do this for all UUID models</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">db_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">auto_now_add</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">creator</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">get_user_model</span><span class="p">(),</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">question</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Question</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">)</span>
    <span class="n">display_set</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">DisplaySet</span><span class="p">,</span> <span class="n">related_name</span><span class="o">=</span><span class="s2">&quot;answers&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span>
    <span class="p">)</span>
    <span class="n">answer</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">JSONField</span><span class="p">(</span>
        <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">JSONValidator</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">ANSWER_TYPE_SCHEMA</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="n">answer_image</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;cases.Image&quot;</span><span class="p">,</span> <span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">PROTECT</span>
    <span class="p">)</span>
    <span class="n">is_ground_truth</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">explanation</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span><span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">last_edit_duration</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DurationField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">total_edit_duration</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">DurationField</span><span class="p">(</span><span class="n">null</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">ordering</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;created&quot;</span><span class="p">,)</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">(</span>
            <span class="p">(</span><span class="s2">&quot;creator&quot;</span><span class="p">,</span> <span class="s2">&quot;display_set&quot;</span><span class="p">,</span> <span class="s2">&quot;question&quot;</span><span class="p">,</span> <span class="s2">&quot;is_ground_truth&quot;</span><span class="p">),</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">question_text</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="si">}</span><span class="s2"> (</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="si">}</span><span class="s2">)&quot;</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">api_url</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;API url for this ``Answer``.&quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;api:reader-studies-answer-detail&quot;</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;pk&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pk</span><span class="p">}</span>
        <span class="p">)</span>

    <span class="c1"># TODO this should be a model clean method</span>
<div class="viewcode-block" id="Answer.validate">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Answer.validate">[docs]</a>
    <span class="nd">@staticmethod</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span>  <span class="c1"># noqa: C901</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">creator</span><span class="p">,</span>
        <span class="n">question</span><span class="p">,</span>
        <span class="n">answer</span><span class="p">,</span>
        <span class="n">display_set</span><span class="p">,</span>
        <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">instance</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Validates all fields provided for ``answer``.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">question</span><span class="o">.</span><span class="n">answer_type</span> <span class="o">==</span> <span class="n">Question</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">HEADING</span><span class="p">:</span>
            <span class="c1"># Maintained for historical consistency</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;Headings are not answerable.&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">question</span><span class="o">.</span><span class="n">is_answer_valid</span><span class="p">(</span><span class="n">answer</span><span class="o">=</span><span class="n">answer</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Your answer is not the correct type. &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">question</span><span class="o">.</span><span class="n">get_answer_type_display</span><span class="p">()</span><span class="si">}</span><span class="s2"> expected, &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span><span class="si">}</span><span class="s2"> found.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">display_set</span><span class="o">.</span><span class="n">reader_study</span> <span class="o">!=</span> <span class="n">question</span><span class="o">.</span><span class="n">reader_study</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Display set </span><span class="si">{</span><span class="n">display_set</span><span class="si">}</span><span class="s2"> does not belong to this reader study.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">is_ground_truth</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">exclude</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="nb">getattr</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="s2">&quot;pk&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
                <span class="o">.</span><span class="n">filter</span><span class="p">(</span>
                    <span class="n">creator</span><span class="o">=</span><span class="n">creator</span><span class="p">,</span>
                    <span class="n">question</span><span class="o">=</span><span class="n">question</span><span class="p">,</span>
                    <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">display_set</span><span class="o">=</span><span class="n">display_set</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="o">.</span><span class="n">exists</span><span class="p">()</span>
            <span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;User </span><span class="si">{</span><span class="n">creator</span><span class="si">}</span><span class="s2"> has already answered this question &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;for this display set.&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">creator</span><span class="o">.</span><span class="n">has_perm</span><span class="p">(</span><span class="s2">&quot;read_readerstudy&quot;</span><span class="p">,</span> <span class="n">question</span><span class="o">.</span><span class="n">reader_study</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span><span class="s2">&quot;This user is not a reader for this study.&quot;</span><span class="p">)</span>

        <span class="n">valid_options</span> <span class="o">=</span> <span class="n">question</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">question</span><span class="o">.</span><span class="n">answer_type</span> <span class="o">==</span> <span class="n">Question</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">question</span><span class="o">.</span><span class="n">required</span><span class="p">:</span>
                <span class="n">valid_options</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">valid_options</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">answer</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_options</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;Provided option is not valid for this question&quot;</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="n">question</span><span class="o">.</span><span class="n">answer_type</span> <span class="o">==</span> <span class="n">Question</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">x</span> <span class="ow">in</span> <span class="n">valid_options</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">answer</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                    <span class="s2">&quot;Provided options are not valid for this question&quot;</span>
                <span class="p">)</span>

        <span class="c1"># Image types can have empty answers while an image is being uploaded,</span>
        <span class="c1"># as such we never consider it empty.</span>
        <span class="n">answer_is_empty</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">answer</span> <span class="o">==</span> <span class="n">question</span><span class="o">.</span><span class="n">empty_answer_value</span>
            <span class="ow">and</span> <span class="ow">not</span> <span class="n">question</span><span class="o">.</span><span class="n">is_image_type</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="n">question</span><span class="o">.</span><span class="n">required</span> <span class="ow">and</span> <span class="n">answer_is_empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">ValidationError</span><span class="p">(</span>
                <span class="s2">&quot;Answer for required question cannot be empty&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">answer_is_empty</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">validator</span> <span class="ow">in</span> <span class="n">question</span><span class="o">.</span><span class="n">validators</span><span class="p">:</span>
                <span class="n">validator</span><span class="p">(</span><span class="n">answer</span><span class="p">)</span></div>


    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">answer_text</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">answer_type</span> <span class="o">==</span> <span class="n">Question</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">CHOICE</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
                <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="o">.</span><span class="n">first</span><span class="p">()</span>
                <span class="ow">or</span> <span class="s2">&quot;&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">answer_type</span> <span class="o">==</span> <span class="n">Question</span><span class="o">.</span><span class="n">AnswerType</span><span class="o">.</span><span class="n">MULTIPLE_CHOICE</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">options</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">pk__in</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>
                <span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span>
                <span class="o">.</span><span class="n">values_list</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">,</span> <span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">answer</span>

<div class="viewcode-block" id="Answer.calculate_score">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Answer.calculate_score">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">calculate_score</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate the score for this ``Answer`` based on ``ground_truth``.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">score</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">calculate_score</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">answer</span><span class="p">,</span> <span class="n">ground_truth</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">score</span></div>


<div class="viewcode-block" id="Answer.save">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.Answer.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">calculate_score</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">adding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_ground_truth</span> <span class="ow">and</span> <span class="n">calculate_score</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">ground_truth</span> <span class="o">=</span> <span class="n">Answer</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                    <span class="n">question</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="p">,</span>
                    <span class="n">is_ground_truth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">display_set</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">display_set</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="n">Answer</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">:</span>
                <span class="k">pass</span>  <span class="c1"># Nothing to do here</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">calculate_score</span><span class="p">(</span><span class="n">ground_truth</span><span class="o">=</span><span class="n">ground_truth</span><span class="o">.</span><span class="n">answer</span><span class="p">)</span>

        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">adding</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assign_permissions</span><span class="p">()</span></div>


    <span class="k">def</span><span class="w"> </span><span class="nf">assign_permissions</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Allow the editors and creator to view this answer</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="s2">&quot;view_answer&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span>
            <span class="s2">&quot;delete_answer&quot;</span><span class="p">,</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">question</span><span class="o">.</span><span class="n">reader_study</span><span class="o">.</span><span class="n">editors_group</span><span class="p">,</span>
            <span class="bp">self</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span><span class="s2">&quot;view_answer&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span>
        <span class="n">assign_perm</span><span class="p">(</span><span class="s2">&quot;change_answer&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">creator</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span></div>



<div class="viewcode-block" id="AnswerUserObjectPermission">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.AnswerUserObjectPermission">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AnswerUserObjectPermission</span><span class="p">(</span><span class="n">UserObjectPermissionBase</span><span class="p">):</span>
    <span class="n">allowed_permissions</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;view_answer&quot;</span><span class="p">,</span> <span class="s2">&quot;change_answer&quot;</span><span class="p">})</span>

    <span class="n">content_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Answer</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span></div>



<div class="viewcode-block" id="AnswerGroupObjectPermission">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.AnswerGroupObjectPermission">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">AnswerGroupObjectPermission</span><span class="p">(</span><span class="n">GroupObjectPermissionBase</span><span class="p">):</span>
    <span class="n">allowed_permissions</span> <span class="o">=</span> <span class="nb">frozenset</span><span class="p">({</span><span class="s2">&quot;view_answer&quot;</span><span class="p">,</span> <span class="s2">&quot;delete_answer&quot;</span><span class="p">})</span>

    <span class="n">content_object</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">Answer</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span></div>



<div class="viewcode-block" id="ReaderStudyPermissionRequest">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudyPermissionRequest">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">ReaderStudyPermissionRequest</span><span class="p">(</span><span class="n">RequestBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    When a user wants to read a reader study, editors have the option of</span>
<span class="sd">    reviewing each user before accepting or rejecting them. This class records</span>
<span class="sd">    the needed info for that.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">reader_study</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="n">ReaderStudy</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="s2">&quot;To which reader study has the user requested access?&quot;</span><span class="p">,</span>
        <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">rejection_text</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">TextField</span><span class="p">(</span>
        <span class="n">blank</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">help_text</span><span class="o">=</span><span class="p">(</span>
            <span class="s2">&quot;The text that will be sent to the user with the reason for their &quot;</span>
            <span class="s2">&quot;rejection.&quot;</span>
        <span class="p">),</span>
    <span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">base_object</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">reader_study</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">object_name</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_object</span><span class="o">.</span><span class="n">title</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">add_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_object</span><span class="o">.</span><span class="n">add_reader</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">remove_method</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_object</span><span class="o">.</span><span class="n">remove_reader</span>

    <span class="nd">@property</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">permission_list_url</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">reverse</span><span class="p">(</span>
            <span class="s2">&quot;reader-studies:permission-request-list&quot;</span><span class="p">,</span>
            <span class="n">kwargs</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;slug&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">base_object</span><span class="o">.</span><span class="n">slug</span><span class="p">},</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">object_name</span><span class="si">}</span><span class="s2"> registration request by user </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">username</span><span class="si">}</span><span class="s2">&quot;</span>

<div class="viewcode-block" id="ReaderStudyPermissionRequest.save">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.ReaderStudyPermissionRequest.save">[docs]</a>
    <span class="k">def</span><span class="w"> </span><span class="nf">save</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">adding</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_state</span><span class="o">.</span><span class="n">adding</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">adding</span><span class="p">:</span>
            <span class="n">process_access_request</span><span class="p">(</span><span class="n">request_object</span><span class="o">=</span><span class="bp">self</span><span class="p">)</span></div>


    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">(</span><span class="n">RequestBase</span><span class="o">.</span><span class="n">Meta</span><span class="p">):</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;reader_study&quot;</span><span class="p">,</span> <span class="s2">&quot;user&quot;</span><span class="p">),)</span></div>



<div class="viewcode-block" id="OptionalHangingProtocolReaderStudy">
<a class="viewcode-back" href="../../../reader-studies.html#grandchallenge.reader_studies.models.OptionalHangingProtocolReaderStudy">[docs]</a>
<span class="k">class</span><span class="w"> </span><span class="nc">OptionalHangingProtocolReaderStudy</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="c1"># Through table for optional hanging protocols</span>
    <span class="c1"># https://docs.djangoproject.com/en/4.2/topics/db/models/#intermediary-manytomany</span>
    <span class="n">reader_study</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span><span class="n">ReaderStudy</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span><span class="p">)</span>
    <span class="n">hanging_protocol</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">ForeignKey</span><span class="p">(</span>
        <span class="s2">&quot;hanging_protocols.HangingProtocol&quot;</span><span class="p">,</span> <span class="n">on_delete</span><span class="o">=</span><span class="n">models</span><span class="o">.</span><span class="n">CASCADE</span>
    <span class="p">)</span>

    <span class="k">class</span><span class="w"> </span><span class="nc">Meta</span><span class="p">:</span>
        <span class="n">unique_together</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;reader_study&quot;</span><span class="p">,</span> <span class="s2">&quot;hanging_protocol&quot;</span><span class="p">),)</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="Related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../../index.html">grand-challenge.org  documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">grandchallenge.reader_studies.models</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright 2018, James Meakin.
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 8.2.3.
    </div>
  </body>
</html>