<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Algorithms &mdash; grand-challenge.org  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=19f00094" />

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="_static/jquery.js?v=5d32c60e"></script>
        <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="_static/documentation_options.js?v=5929fcd5"></script>
        <script src="_static/doctools.js?v=888ff710"></script>
        <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Components" href="components.html" />
    <link rel="prev" title="Evaluation" href="evaluation.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            grand-challenge.org
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="evaluation.html">Evaluation</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Algorithms</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#what-is-an-algorithm">What is an algorithm?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#algorithm-inputs">Algorithm Inputs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#image-files">Image files</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#execution">Execution</a></li>
<li class="toctree-l2"><a class="reference internal" href="#algorithm-outputs">Algorithm Outputs</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#results-json">results.json</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#frequently-asked-questions">Frequently Asked Questions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#what-resources-are-available">What resources are available?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#where-can-i-write-data">Where can I write data?</a></li>
<li class="toctree-l3"><a class="reference internal" href="#time-limit-exceeded-errors-with-pytorch">Time limit exceeded errors with PyTorch</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pthread-setaffinity-np-failed-errors-with-onnx-runtime">pthread_setaffinity_np failed errors with ONNX Runtime</a></li>
<li class="toctree-l3"><a class="reference internal" href="#output-overlay-not-visible-or-incorrectly-placed-on-input-image">Output overlay not visible or incorrectly placed on input image</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="components.html">Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="workstations.html">Workstations</a></li>
<li class="toctree-l1"><a class="reference internal" href="reader-studies.html">Reader Studies</a></li>
<li class="toctree-l1"><a class="reference internal" href="design.html">Design decisions</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">grand-challenge.org</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Algorithms</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/algorithms.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="algorithms">
<h1>Algorithms<a class="headerlink" href="#algorithms" title="Link to this heading"></a></h1>
<section id="what-is-an-algorithm">
<h2>What is an algorithm?<a class="headerlink" href="#what-is-an-algorithm" title="Link to this heading"></a></h2>
<p>An algorithm is a container image that is executed on a set of inputs, producing a set of outputs. The inputs and outputs can be text, numbers, booleans, medical images or annotations.</p>
</section>
<section id="algorithm-inputs">
<h2>Algorithm Inputs<a class="headerlink" href="#algorithm-inputs" title="Link to this heading"></a></h2>
<p>Inputs to an algorithm are available in the container in the <code class="docutils literal notranslate"><span class="pre">/input</span></code> directory.
You can specify <a class="reference internal" href="components.html#components"><span class="std std-ref">component interfaces</span></a> that will provide the inputs to your algorithm in the “Inputs” field on the create/update algorithm form.
You can find a list of the <a class="reference external" href="https://grand-challenge.org/algorithms/interfaces/">currently available interfaces</a> on grand challenge.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">relative_path</span></code> property on the <code class="docutils literal notranslate"><span class="pre">ComponentInterface</span></code> is used to determine where the input value will be placed inside the container.</p>
<p>Most types get written to a json file, located in <code class="docutils literal notranslate"><span class="pre">/input/{relative_path}</span></code> in the container.
You can read and parse these with</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">json</span>

<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/input/</span><span class="si">{relative_path}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<p>When creating a new job for an algorithm, you can provide values for all <code class="docutils literal notranslate"><span class="pre">ComponentInterfaces</span></code> using the form provided.</p>
<section id="image-files">
<h3>Image files<a class="headerlink" href="#image-files" title="Link to this heading"></a></h3>
<p>Grand Challenge works with two image formats that will need to be read or written by your algorithm container image <code class="docutils literal notranslate"><span class="pre">.mha</span></code> and <code class="docutils literal notranslate"><span class="pre">.tif</span></code>.</p>
</section>
</section>
<section id="execution">
<h2>Execution<a class="headerlink" href="#execution" title="Link to this heading"></a></h2>
<p>A container will be created from the container image whenever you create a job for your algorithm.</p>
<p>Any output for both <cite>stdout</cite> and <cite>stderr</cite> is captured. The output for <cite>stderr</cite> gets marked as a warning in the job’s result.</p>
<p>If an algorithm does not properly run, it should exit with a non zero exit code. The job for the algorithm then gets marked as failed.</p>
</section>
<section id="algorithm-outputs">
<h2>Algorithm Outputs<a class="headerlink" href="#algorithm-outputs" title="Link to this heading"></a></h2>
<p>Outputs of an algorithm must be stored in the directory <code class="docutils literal notranslate"><span class="pre">/output/</span></code>.
As with the inputs, a <code class="docutils literal notranslate"><span class="pre">ComponentInterface</span></code> needs to be defined for each of the expected outputs in the “Outputs” field on the create/update algorithm form.
You can find a list of the <a class="reference external" href="https://grand-challenge.org/algorithms/interfaces/">currently available interfaces</a> on grand challenge.</p>
<section id="results-json">
<h3>results.json<a class="headerlink" href="#results-json" title="Link to this heading"></a></h3>
<p>If one of the defined outputs for the algorithms is a <code class="docutils literal notranslate"><span class="pre">results.json</span></code> file, the contents of this file will be parsed and shown on the algorithm’s result page. You can provide a jinja template to an algorithm for the rendering of these results.</p>
</section>
</section>
<section id="frequently-asked-questions">
<h2>Frequently Asked Questions<a class="headerlink" href="#frequently-asked-questions" title="Link to this heading"></a></h2>
<section id="what-resources-are-available">
<h3>What resources are available?<a class="headerlink" href="#what-resources-are-available" title="Link to this heading"></a></h3>
<p>Currently algorithms are run with 1 NVidia T4 GPU with CUDA 10 and 16GB GPU memory.
Algorithms are allowed to use 200% CPU, 24GB system memory and 512 threads.
The algorithms are run without any access to the network.
All container privileges are dropped.</p>
</section>
<section id="where-can-i-write-data">
<h3>Where can I write data?<a class="headerlink" href="#where-can-i-write-data" title="Link to this heading"></a></h3>
<p>The container filesystem and output directories are writable, the input directory is read only.</p>
</section>
<section id="time-limit-exceeded-errors-with-pytorch">
<h3>Time limit exceeded errors with PyTorch<a class="headerlink" href="#time-limit-exceeded-errors-with-pytorch" title="Link to this heading"></a></h3>
<p>Algorithms have a wall time limit of 2 hours.
Sometimes, the algorithm will produce little to no output in the logs.
Often, this is due to using PyTorch <code class="docutils literal notranslate"><span class="pre">DataLoaders</span></code>.
These require using shared memory, which is not enabled on grand-challenge.org.
To resolve this, set <code class="docutils literal notranslate"><span class="pre">num_workers</span></code> to <code class="docutils literal notranslate"><span class="pre">0</span></code> when initialising your <code class="docutils literal notranslate"><span class="pre">DataLoader</span></code>.</p>
</section>
<section id="pthread-setaffinity-np-failed-errors-with-onnx-runtime">
<h3>pthread_setaffinity_np failed errors with ONNX Runtime<a class="headerlink" href="#pthread-setaffinity-np-failed-errors-with-onnx-runtime" title="Link to this heading"></a></h3>
<p>Algorithms are limited to a select number of CPUs.
Because of that ONNX Runtime does not have the permissions to automatically set the CPU affinities.
To solve this create an InferenceSession by explicitly providing the number of threads via a SessionOptions instance. E.g.:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">onnxruntime</span>

<span class="n">so</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">SessionOptions</span><span class="p">()</span>
<span class="n">so</span><span class="o">.</span><span class="n">inter_op_num_threads</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">so</span><span class="o">.</span><span class="n">intra_op_num_threads</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">onnxruntime</span><span class="o">.</span><span class="n">InferenceSession</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="n">sess_options</span><span class="o">=</span><span class="n">so</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="output-overlay-not-visible-or-incorrectly-placed-on-input-image">
<h3>Output overlay not visible or incorrectly placed on input image<a class="headerlink" href="#output-overlay-not-visible-or-incorrectly-placed-on-input-image" title="Link to this heading"></a></h3>
<p>It is important to specify the correct voxel spacing, origin, and direction for image outputs that should be shown as overlays on the input images. When using <code class="docutils literal notranslate"><span class="pre">output_sitk_img</span> <span class="pre">=</span> <span class="pre">SimpleITK.GetImageFromArray(numpy_array)</span></code> SimpleITK will set default values that might not correspond with the input image resulting in an incorrectly placed overlay. Use <code class="docutils literal notranslate"><span class="pre">output_sitk_img.CopyInformation(input_sitk_img)</span></code> to copy the origin, spacing and direction values from the input image to the output image to ensure they correspond.</p>
</section>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="evaluation.html" class="btn btn-neutral float-left" title="Evaluation" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="components.html" class="btn btn-neutral float-right" title="Components" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, James Meakin.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>